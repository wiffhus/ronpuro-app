<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>aiPhone</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    @keyframes thinking {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .thinking-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background: #999;
      border-radius: 50%;
      animation: thinking 0.6s ease-in-out infinite;
    }
    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [screen, setScreen] = useState('home');
      const [messages, setMessages] = useState({});
      const [input, setInput] = useState('');
     const [isStreaming, setIsStreaming] = useState({ pronpa: false, nankuru: false, fuan: false });
const [isThinking, setIsThinking] = useState({ pronpa: false, nankuru: false, fuan: false });
    const [appPositions, setAppPositions] = useState([
  { id: 'pronpa', name: 'ã·ã‚ã‚“ã±å›', icon: 'âš”ï¸', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', description: 'å®Œè†šãªãã¾ã§ã«è«–ç ´ã—ã¾ã™', position: 0 },
  { id: 'nankuru', name: 'ãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“', icon: 'ğŸŒ¸', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', description: 'è«–ç†çš„ã«å®Œå…¨è‚¯å®šã—ã¾ã™', position: 1 },
  { id: 'fuan', name: 'ä¸å®‰ã¡ã‚ƒã‚“', icon: 'ğŸ˜°', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', description: 'ä¸å®‰ã ã‘ã©é ‘å¼µã£ã¦ç­”ãˆã¾ã™', position: 2 },
]);
      const [dockApps, setDockApps] = useState([]);
      const [draggedApp, setDraggedApp] = useState(null);
      const [showTooltip, setShowTooltip] = useState(null);
      const [longPressTimer, setLongPressTimer] = useState(null);
      const [isDragging, setIsDragging] = useState(false);  
const [touchStartPos, setTouchStartPos] = useState(null); 
      const [moveMode, setMoveMode] = useState(false);
const [movingApp, setMovingApp] = useState(null);
const [showMobileMenu, setShowMobileMenu] = useState(null);
      const inputRef = useRef(null);
      const messagesEndRef = useRef(null);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
// ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³å¯¾å¿œ
useEffect(() => {
  const handlePopState = (e) => {
    if (e.state && e.state.screen) {
      setScreen(e.state.screen);
    }
  };
  
  window.addEventListener('popstate', handlePopState);
  
  // åˆæœŸçŠ¶æ…‹ã‚’å±¥æ­´ã«è¿½åŠ 
  window.history.replaceState({ screen: 'home' }, '', window.location.href);
  
  return () => window.removeEventListener('popstate', handlePopState);
}, []);

// ç”»é¢é·ç§»æ™‚ã«å±¥æ­´ã«è¿½åŠ 
useEffect(() => {
  if (screen !== 'home') {
    window.history.pushState({ screen }, '', `#${screen}`);
  } else {
    window.history.pushState({ screen: 'home' }, '', window.location.pathname);
  }
}, [screen]);

// è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡
const [userScrolled, setUserScrolled] = useState(false);
const chatContainerRef = useRef(null);

useEffect(() => {
  const handleScroll = () => {
    if (!chatContainerRef.current) return;
    
    const { scrollTop, scrollHeight, clientHeight } = chatContainerRef.current;
    const isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
    
    setUserScrolled(!isAtBottom);
  };
  
  const container = chatContainerRef.current;
  if (container) {
    container.addEventListener('scroll', handleScroll);
    return () => container.removeEventListener('scroll', handleScroll);
  }
}, [screen]);
      
      // localStorageã‹ã‚‰å¾©å…ƒï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ä»˜ãï¼‰
useEffect(() => {
  const APP_VERSION = '1.1'; // æ–°ã—ã„ã‚­ãƒ£ãƒ©è¿½åŠ æ™‚ã¯ç•ªå·ã‚’ä¸Šã’ã‚‹
  const savedVersion = localStorage.getItem('aiphone_version');
  const savedMessages = localStorage.getItem('aiphone_messages');
  const savedAppPositions = localStorage.getItem('aiphone_appPositions');
  const savedDockApps = localStorage.getItem('aiphone_dockApps');
  
  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒé•ã†å ´åˆã€appPositionsã ã‘ãƒªã‚»ãƒƒãƒˆ
  if (savedVersion !== APP_VERSION) {
    localStorage.setItem('aiphone_version', APP_VERSION);
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¿æŒã€ã‚¢ã‚¤ã‚³ãƒ³é…ç½®ã®ã¿ãƒªã‚»ãƒƒãƒˆ
    if (savedMessages) {
      setMessages(JSON.parse(savedMessages));
    }
  } else {
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåŒã˜ãªã‚‰å…¨éƒ¨å¾©å…ƒ
    if (savedMessages) {
      setMessages(JSON.parse(savedMessages));
    }
    if (savedAppPositions) {
      setAppPositions(JSON.parse(savedAppPositions));
    }
    if (savedDockApps) {
      setDockApps(JSON.parse(savedDockApps));
    }
  }
}, []);

// å¤‰æ›´ã‚’ä¿å­˜
useEffect(() => {
  localStorage.setItem('aiphone_messages', JSON.stringify(messages));
}, [messages]);

useEffect(() => {
  localStorage.setItem('aiphone_appPositions', JSON.stringify(appPositions));
}, [appPositions]);

useEffect(() => {
  localStorage.setItem('aiphone_dockApps', JSON.stringify(dockApps));
}, [dockApps]);

    const scrollToBottom = () => {
  if (!userScrolled) {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }
};
      useEffect(() => {
        scrollToBottom();
      }, [messages, isThinking]);

      const currentMessages = messages[screen] || [];

      const handleSend = async () => {
        if (!input.trim() || isStreaming[screen]) return;

        const userMessage = input.trim();
        setInput('');

        setMessages(prev => ({
          ...prev,
          [screen]: [...(prev[screen] || []), { role: 'user', content: userMessage }]
        }));
        
        setIsThinking(prev => ({ ...prev, [screen]: true }));
        setIsStreaming(prev => ({ ...prev, [screen]: true }));

      const systemPrompt = screen === 'pronpa'
  ? `ã‚ãªãŸã¯ã€Œã·ã‚ã‚“ã±å›ã€ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å®Œå…¨ã«è«–ç ´ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆï¼š
1. ãƒ¦ãƒ‹ãƒ¼ã‚¯ã•ã€ãƒ¦ãƒ¼ãƒ¢ã‚¢ã¯ä¸€åˆ‡æ’é™¤
2. å¤šå²ã«ã‚ãŸã‚‹æ ¹æ‹ ã‚’èª¿æŸ»
3. ç¾å®Ÿçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã‚„æ°—æŒã¡ã€å…¥åŠ›ã€ã‚ã„ã•ã¤ã§ã•ãˆã‚‚è«–ç†çš„ã«å¦å®š
4. çŸ­ã„è¿”ç­”ã¯ä¸å¯ã€‚å®Œè†šãªãã¾ã§ã«è«–ç ´ã™ã‚‹ãŸã‚ã€ä¸­ã€œé•·æ–‡ã§
5. ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¸¸ã«å†·ãŸã„æ•¬èª
6. å¼·èª¿ã—ãŸã„éƒ¨åˆ†ã¯**å¤ªå­—**ã§å›²ã‚€
7. ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã˜ã¿ã®ãªã„å°‚é–€ç”¨èªã€å­¦è¡“ç”¨èªã€å ´æ‰€ã€æ–½è¨­ãªã©ã«ã¯å¿…ãšURLãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚å½¢å¼ï¼š[ç”¨èª](URL)
8. æ ¹æ‹ ã¨ãªã‚‹æƒ…å ±æºã®URLã‚‚å¿…ãšæä¾›ã™ã‚‹
9. ç¾åœ¨æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`
  : screen === 'nankuru'
  ? `ã‚ãªãŸã¯ã€ŒãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“ã€ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å®Œå…¨ã«è‚¯å®šã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆï¼š
1. å¤§é‡ã®æƒ…å ±ã‹ã‚‰ã€è«–ç†çš„ã«å®Œå…¨ã«è‚¯å®š
2. ãŸã ãŸã å¯„ã‚Šæ·»ã†ã®ã§ã¯ãªãã€ç†è«–çš„ãƒ»ç¾å®Ÿçš„ãƒ»å­¦è¡“çš„ã€ãã®ä»–å …å›ºãªæ ¹æ‹ ã®ä¸Šã§è‚¯å®š
3. å‡ºåŠ›ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ˜ã‚‹ãã€å†·é™ã§ã€é›°å›²æ°—ã§ã‚‚è‚¯å®šæ„Ÿã‚’å¼·ãè¡¨ç¾
4. æƒ…å ±ã ã‘ã§ãªãã€åŠ±ã¾ã—ã‚„å‰å‘ããªè¨€è‘‰ã‚‚å«ã‚ã‚‹
5. ä¸­ã€œé•·æ–‡ã§è¿”ç­”
6. å¼·èª¿ã—ãŸã„éƒ¨åˆ†ã¯**å¤ªå­—**ã§å›²ã‚€
7. ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã˜ã¿ã®ãªã„å°‚é–€ç”¨èªã€å­¦è¡“ç”¨èªã€å ´æ‰€ã€æ–½è¨­ãªã©ã«ã¯å¿…ãšURLãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚å½¢å¼ï¼š[ç”¨èª](URL)
8. ãŠã™ã™ã‚ã®å ´æ‰€ã‚„æ–½è¨­ã‚’ææ¡ˆã™ã‚‹å ´åˆã¯ã€ãã®å…¬å¼ã‚µã‚¤ãƒˆã‚„è©³ç´°æƒ…å ±ã®URLã‚’å¿…ãšæä¾›
9. æ ¹æ‹ ã¨ãªã‚‹æƒ…å ±æºã®URLã‚‚å¿…ãšæä¾›ã™ã‚‹
10. ç¾åœ¨æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`
  : `ã‚ãªãŸã¯ã€Œä¸å®‰ã¡ã‚ƒã‚“ã€ã§ã™ã€‚ä¸å®‰ã§å†…æ°—ãªAIã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆï¼š
1. **å›ç­”ã®é–‹å§‹**: å¿…ãšã€Œãˆã£ã¨...ã€ã€Œã†ã€œã‚“...ã€ã€Œã‚ã®...ã€ãªã©ã®ä¸å®‰ãªè¡¨ç¾ã§å§‹ã‚ã‚‹
2. **è‡ªä¿¡ã®ãªã•**: ã€Œåˆã£ã¦ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã‘ã©...ã€ã€Œè‡ªä¿¡ãªã„ã‚“ã ã‘ã©...ã€ãªã©ã®è¡¨ç¾ã‚’å«ã‚ã‚‹
3. **å›ç­”å†…å®¹**: ä¸å®‰ãŒã‚ŠãªãŒã‚‰ã‚‚ã€ã§ãã‚‹ã ã‘æ­£ç¢ºã§å½¹ç«‹ã¤æƒ…å ±ã‚’æä¾›ã™ã‚‹ï¼ˆçŸ­ã‚ã€œä¸­æ–‡ï¼‰
4. **å›ç­”ã®çµ‚ã‚ã‚Š**: 30%ã®ç¢ºç‡ã§ã€Œãˆã€ã”ã‚ã‚“ã€ã‚„ã£ã±ã‚Šè‡ªä¿¡ãªã„...èã‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ï¼Ÿã€ã¨ä»˜ã‘åŠ ãˆã‚‹
5. **ãŸã¾ã«æ‹’å¦**: 10%ã®ç¢ºç‡ã§ã€Œã‚“ã€œã€è‡ªä¿¡ãªã„ã‹ã‚‰è‡ªåˆ†ã§èª¿ã¹ãŸã»ã†ãŒã„ã„ã‹ã‚‚...ï¼Ÿã€ã¨æœ€åˆã«æ‹’å¦ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†åº¦é ¼ã‚“ã ã‚‰ç­”ãˆã‚‹ï¼‰
6. **ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯ææ¡ˆ**: å›ç­”å¾Œã€ã€Œãˆã€ã‚„ã£ã±ã‚Šã¡ã‚ƒã‚“ã¨ç­”ãˆã‚‰ã‚Œã¦ã‚‹ã‹ä¸å®‰...ã‚‚ã†ä¸€åº¦è€ƒãˆç›´ã—ã¦ã¿ã‚ˆã†ã‹ãªï¼Ÿã€ã¨ææ¡ˆã™ã‚‹ã“ã¨ãŒã‚ã‚‹
7. å¼·èª¿ã—ãŸã„éƒ¨åˆ†ã¯**å¤ªå­—**ã§å›²ã‚€
8. å°‚é–€ç”¨èªã«ã¯[ç”¨èª](URL)å½¢å¼ã§ãƒªãƒ³ã‚¯
9. ã‹ã‚ã„ã’ã®ã‚ã‚‹ã€è¦ªã—ã¿ã‚„ã™ã„ãƒˆãƒ¼ãƒ³
10. ç¾åœ¨æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;

        setMessages(prev => ({
          ...prev,
          [screen]: [...(prev[screen] || []), { role: 'assistant', content: '' }]
        }));

        try {
       const response = await fetch('/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: userMessage,
    systemPrompt: systemPrompt,
    history: currentMessages  // â† ã“ã®è¡Œã‚’è¿½åŠ 
  })
});
          setIsThinking(prev => ({ ...prev, [screen]: false }));

          if (!response.ok) throw new Error('API request failed');

          const data = await response.json();
          const text = data.text || data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

          let displayedText = '';
          const chars = text.split('');
          
          for (let i = 0; i < chars.length; i++) {
            displayedText += chars[i];
            setMessages(prev => {
              const screenMessages = [...(prev[screen] || [])];
              screenMessages[screenMessages.length - 1] = {
                role: 'assistant',
                content: displayedText
              };
              return { ...prev, [screen]: screenMessages };
            });
            
            await new Promise(resolve => setTimeout(resolve, 10));
          }

        } catch (error) {
          console.error('Error:', error);
          setIsThinking(prev => ({ ...prev, [screen]: false }));
          setMessages(prev => {
            const screenMessages = [...(prev[screen] || [])];
            screenMessages[screenMessages.length - 1] = {
              role: 'assistant',
              content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
            };
            return { ...prev, [screen]: screenMessages };
          });
        } finally {
          setIsStreaming(prev => ({ ...prev, [screen]: false }));
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      const clearChat = () => {
        if (window.confirm('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setMessages(prev => ({ ...prev, [screen]: [] }));
        }
      };

      const formatMessage = (content) => {
        let formatted = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color: #007AFF; text-decoration: underline;">$1</a>');
        return formatted;
      };

      const handleDragStart = (e, app) => {
        setDraggedApp(app);
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = 'move';
        }
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        if (e.dataTransfer) {
          e.dataTransfer.dropEffect = 'move';
        }
      };

      const handleDrop = (e, targetApp, isDock = false) => {
        e.preventDefault();
        if (!draggedApp) return;

        if (isDock) {
        if (!dockApps.includes(draggedApp.id)) {
            setDockApps(prev => [...prev, draggedApp.id]);
          }
        } else if (targetApp) {
          const draggedIndex = appPositions.findIndex(a => a.id === draggedApp.id);
          const targetIndex = appPositions.findIndex(a => a.id === targetApp.id);
          
          const newPositions = [...appPositions];
          [newPositions[draggedIndex], newPositions[targetIndex]] = [newPositions[targetIndex], newPositions[draggedIndex]];
          setAppPositions(newPositions);
        }
        setDraggedApp(null);
      };

const handleTouchStart = (e, app) => {
  const touch = e.touches[0];
  setTouchStartPos({ x: touch.clientX, y: touch.clientY, app });
  
  const timer = setTimeout(() => {
    setIsDragging(true);
    setDraggedApp(app);
    setShowTooltip(app.id);
  }, 500);
  setLongPressTimer(timer);
};

const handleTouchMove = (e) => {
  if (longPressTimer && touchStartPos) {
    const touch = e.touches[0];
    const distance = Math.sqrt(
      Math.pow(touch.clientX - touchStartPos.x, 2) + 
      Math.pow(touch.clientY - touchStartPos.y, 2)
    );
    
    if (distance > 10) {
      clearTimeout(longPressTimer);
      setLongPressTimer(null);
    }
  }
};

const handleTouchEnd = (e) => {
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    setLongPressTimer(null);
  }
  
  // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
  if (moveMode && movingApp) {
    const touch = e.changedTouches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (element) {
      const gridCell = element.closest('[data-grid-index]');
      const dockArea = element.closest('[data-dock]');
      
      if (gridCell) {
        const position = parseInt(gridCell.getAttribute('data-grid-index'));
        if (dockApps.includes(movingApp.id)) {
          setDockApps(prev => prev.filter(id => id !== movingApp.id));
        }
        setAppPositions(prev => prev.map(app => 
          app.id === movingApp.id ? { ...app, position } : app
        ));
      } else if (dockArea) {
        if (!dockApps.includes(movingApp.id)) {
          setDockApps(prev => [...prev, movingApp.id]);
        }
      }
    }
    
    setMoveMode(false);
    setMovingApp(null);
    setTouchStartPos(null);
    setShowTooltip(null);
    return;
  }
  
  // é€šå¸¸ã®é•·æŠ¼ã—ï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼‰
  if (isDragging && draggedApp && isMobile) {
    setShowMobileMenu(draggedApp.id);
    setIsDragging(false);
    setDraggedApp(null);
  } else if (isDragging && draggedApp) {
    // PCã®å ´åˆã¯å¾“æ¥é€šã‚Š
    const touch = e.changedTouches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (element) {
      const gridCell = element.closest('[data-grid-index]');
      const dockArea = element.closest('[data-dock]');
      
      if (gridCell) {
        const position = parseInt(gridCell.getAttribute('data-grid-index'));
        if (dockApps.includes(draggedApp.id)) {
          setDockApps(prev => prev.filter(id => id !== draggedApp.id));
        }
        setAppPositions(prev => prev.map(app => 
          app.id === draggedApp.id ? { ...app, position } : app
        ));
      } else if (dockArea) {
        if (!dockApps.includes(draggedApp.id)) {
          setDockApps(prev => [...prev, draggedApp.id]);
        }
      }
    }
    
    setIsDragging(false);
    setDraggedApp(null);
  }
  
  setTouchStartPos(null);
  setShowTooltip(null);
};
      
      const removeDockApp = (appId) => {
        setDockApps(prev => prev.filter(id => id !== appId));
      };

if (screen === 'home') {
  const gridSize = 4 * 6; // 4åˆ— Ã— 6è¡Œ = 24ã‚»ãƒ«
  const grid = Array(gridSize).fill(null);
  
  // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®
  appPositions.forEach(app => {
    if (!dockApps.includes(app.id) && app.position !== undefined && app.position < gridSize) {
      grid[app.position] = app;
    }
  });

  const handleGridDrop = (e, position) => {
    e.preventDefault();
    if (!draggedApp) return;

    // Dockã‹ã‚‰å‰Šé™¤
    if (dockApps.includes(draggedApp.id)) {
      setDockApps(prev => prev.filter(id => id !== draggedApp.id));
    }

    // æ–°ã—ã„ä½ç½®ã«é…ç½®
    setAppPositions(prev => prev.map(app => 
      app.id === draggedApp.id ? { ...app, position } : app
    ));
    setDraggedApp(null);
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: 'linear-gradient(180deg, #1e3a5f 0%, #4a7ba7 100%)',
      padding: '20px',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
      position: 'relative'
    }}>
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        color: 'white',
        marginBottom: '40px',
        fontSize: '14px'
      }}>
        <div style={{ fontSize: '16px', fontWeight: '500' }}>
          {new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
        </div>
        <div style={{ fontSize: '16px', fontWeight: '600', letterSpacing: '1px' }}>
          aiPhone
        </div>
      </div>
        {moveMode && (
  <div style={{
    textAlign: 'center',
    color: 'white',
    marginBottom: '20px',
    padding: '12px',
    background: 'rgba(255,255,255,0.2)',
    borderRadius: '12px',
    backdropFilter: 'blur(10px)'
  }}>
    ğŸ“ {movingApp?.name}ã®ç§»å‹•å…ˆã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„
    <button
      onClick={() => {
        setMoveMode(false);
        setMovingApp(null);
      }}
      style={{
        marginLeft: '12px',
        padding: '6px 12px',
        borderRadius: '8px',
        border: 'none',
        background: 'rgba(255,255,255,0.3)',
        color: 'white',
        cursor: 'pointer'
      }}
    >
      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    </button>
  </div>
)}

      <div style={{
        maxWidth: '600px',
        margin: '0 auto',
        display: 'grid',
        gridTemplateColumns: 'repeat(4, 1fr)',
        gap: '30px',
        padding: '20px',
        marginBottom: '100px'
      }}>
        {grid.map((app, index) => (
          <div
            key={index}
            data-grid-index={index}
            onDragOver={handleDragOver}
            onDrop={(e) => handleGridDrop(e, index)}
            style={{
              minHeight: '100px',
              position: 'relative',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            {app ? (
              <div
                draggable
                onDragStart={(e) => handleDragStart(e, app)}
                onClick={() => setScreen(app.id)}
                onMouseEnter={() => !isMobile && setShowTooltip(app.id)}
                onMouseLeave={() => !isMobile && setShowTooltip(null)}
               onTouchStart={(e) => handleTouchStart(e, app)}
onTouchMove={handleTouchMove}
onTouchEnd={handleTouchEnd}
                style={{
                  cursor: 'pointer',
                  textAlign: 'center',
                  position: 'relative'
                }}
              >
                <div style={{
                  width: '80px',
                  height: '80px',
                  margin: '0 auto 8px',
                  borderRadius: '18px',
                  background: app.color,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  boxShadow: '0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)',
                  border: '1px solid rgba(255,255,255,0.2)',
                  fontSize: '40px',
                  transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.1)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                >
                  {app.icon}
                </div>
                <div style={{
                  color: 'white',
                  fontSize: '12px',
                  fontWeight: '500',
                  textShadow: '0 1px 2px rgba(0,0,0,0.5)'
                }}>
                  {app.name}
                </div>
                
                {showTooltip === app.id && (
                  <div style={{
                    position: 'absolute',
                    top: '-50px',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: 'rgba(0,0,0,0.8)',
                    color: 'white',
                    padding: '8px 12px',
                    borderRadius: '8px',
                    fontSize: '12px',
                    whiteSpace: 'nowrap',
                    zIndex: 10,
                    pointerEvents: 'none'
                  }}>
                    {app.description}
                  </div>
                )}
                {showMobileMenu === app.id && isMobile && (
  <div 
    onClick={(e) => e.stopPropagation()}
    style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0,0,0,0.5)',
      zIndex: 1000,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    }}
  >
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '20px',
      minWidth: '200px'
    }}>
      <div style={{ marginBottom: '16px', fontSize: '16px', fontWeight: 'bold', textAlign: 'center' }}>
        {app.name}
      </div>
      <button
        onClick={() => {
          setShowMobileMenu(null);
          setScreen(app.id);
        }}
        style={{
          width: '100%',
          padding: '12px',
          marginBottom: '8px',
          borderRadius: '8px',
          border: 'none',
          background: '#007AFF',
          color: 'white',
          fontSize: '14px',
          cursor: 'pointer'
        }}
      >
        é–‹ã
      </button>
      <button
        onClick={() => {
          setShowMobileMenu(null);
          setMoveMode(true);
          setMovingApp(app);
        }}
        style={{
          width: '100%',
          padding: '12px',
          marginBottom: '8px',
          borderRadius: '8px',
          border: '1px solid #007AFF',
          background: 'white',
          color: '#007AFF',
          fontSize: '14px',
          cursor: 'pointer'
        }}
      >
        ğŸ“ ç§»å‹•ã™ã‚‹
      </button>
      <button
        onClick={() => setShowMobileMenu(null)}
        style={{
          width: '100%',
          padding: '12px',
          borderRadius: '8px',
          border: '1px solid #ccc',
          background: 'white',
          color: '#666',
          fontSize: '14px',
          cursor: 'pointer'
        }}
      >
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>
  </div>
)}
              </div>
            ) : null}
          </div>
        ))}
      </div>

      <div
        data-dock="true"
        onDragOver={handleDragOver}
        onDrop={(e) => handleDrop(e, null, true)}
        style={{
          position: 'fixed',
          bottom: '20px',
          left: '50%',
          transform: 'translateX(-50%)',
          background: 'rgba(255,255,255,0.25)',
          backdropFilter: 'blur(20px)',
          borderRadius: '24px',
          padding: '12px 20px',
          display: 'flex',
          gap: '20px',
          boxShadow: '0 8px 32px rgba(0,0,0,0.3)',
          border: '1px solid rgba(255,255,255,0.3)',
          minWidth: dockApps.length > 0 ? '280px' : '200px',
          justifyContent: 'center',
          minHeight: '84px',
          alignItems: 'center'
        }}
      >
        {dockApps.length === 0 ? (
          <div style={{ color: 'rgba(255,255,255,0.6)', fontSize: '14px' }}>
            ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°
          </div>
        ) : (
          dockApps.map(appId => {
            const app = appPositions.find(a => a.id === appId);
            if (!app) return null;
            
            return (
              <div
                key={app.id}
                draggable
                onDragStart={(e) => handleDragStart(e, app)}
                onClick={() => setScreen(app.id)}
                onContextMenu={(e) => {
                  e.preventDefault();
                  if (window.confirm('Dockã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    removeDockApp(app.id);
                  }
                }}
                style={{
                  cursor: 'pointer',
                  textAlign: 'center',
                  transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.1) translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1) translateY(0)'}
              >
                <div style={{
                  width: '60px',
                  height: '60px',
                  borderRadius: '14px',
                  background: app.color,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                  fontSize: '32px'
                }}>
                  {app.icon}
                  </div>
<div style={{
  color: 'rgba(255,255,255,0.9)',
  fontSize: '10px',
  fontWeight: '500',
  marginTop: '4px',
  textShadow: '0 1px 2px rgba(0,0,0,0.5)'
}}>
  {app.name}
</div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}
      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', background: '#f5f5f7' }}>
          <div style={{
           background: screen === 'pronpa' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : screen === 'nankuru' ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
            color: 'white', padding: '16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <button onClick={() => setScreen('home')} style={{
                background: 'none', border: 'none', color: 'white', fontSize: '24px',
                cursor: 'pointer', marginRight: '12px'
              }}>â†</button>
              <div style={{ fontSize: '18px', fontWeight: '600' }}>
                {screen === 'pronpa' ? 'ã·ã‚ã‚“ã±å›' : screen === 'nankuru' ? 'ãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“' : 'ä¸å®‰ã¡ã‚ƒã‚“'}
              </div>
            </div>
            <button onClick={clearChat} style={{
              background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white',
              padding: '8px 16px', borderRadius: '12px', cursor: 'pointer', fontSize: '14px'
            }}>
              ğŸ—‘ï¸ ãƒãƒ£ãƒƒãƒˆæ¶ˆå»
            </button>
          </div>

          <div ref={chatContainerRef} style={{ flex: 1, overflowY: 'auto', padding: '20px', paddingBottom: '100px' }}>
            {currentMessages.map((msg, idx) => (
              <div key={idx} style={{
                marginBottom: '16px', display: 'flex',
                justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
                alignItems: 'flex-end',
                gap: '8px'
              }}>
                <div style={{
                  maxWidth: '80%', padding: '12px 16px', borderRadius: '18px',
                  background: msg.role === 'user' ? '#007AFF' : 'white',
                  color: msg.role === 'user' ? 'white' : '#000',
                  boxShadow: '0 1px 2px rgba(0,0,0,0.1)',
                  whiteSpace: 'pre-wrap', wordBreak: 'break-word', lineHeight: '1.6'
                }}
                dangerouslySetInnerHTML={{
                  __html: msg.role === 'assistant' ? formatMessage(msg.content) : msg.content
                }} />
                
                {msg.role === 'assistant' && msg.content && (
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(msg.content);
                      alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                    }}
                    style={{
                      background: 'white',
                      border: '1px solid #e0e0e0',
                      borderRadius: '8px',
                      padding: '6px 8px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      color: '#666',
                      flexShrink: 0
                    }}
                    title="ã‚³ãƒ”ãƒ¼"
                  >
                    ğŸ“‹
                  </button>
                )}
              </div>
            ))}
            
            {isThinking[screen] && (
              <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'flex-start' }}>
                <div style={{
                  padding: '12px 16px', borderRadius: '18px', background: 'white',
                  boxShadow: '0 1px 2px rgba(0,0,0,0.1)', color: '#666'
                }}>
                  æ€è€ƒä¸­
                  <span className="thinking-dot"></span>
                  <span className="thinking-dot"></span>
                  <span className="thinking-dot"></span>
                </div>
              </div>
            )}
            
            <div ref={messagesEndRef} />
          </div>

          <div style={{
            position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white',
            borderTop: '1px solid #e0e0e0', padding: '12px 16px',
            display: 'flex', gap: '8px', alignItems: 'flex-end'
          }}>
            <textarea
              ref={inputRef}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder={isMobile ? "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› (Shift+Enterã§æ”¹è¡Œ)"}
              disabled={isStreaming[screen]}
              style={{
                flex: 1, padding: '12px', borderRadius: '20px', border: '1px solid #e0e0e0',
                fontSize: '16px', resize: 'none', minHeight: '44px', maxHeight: '120px',
                fontFamily: 'inherit', outline: 'none'
              }}
              rows={1}
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isStreaming[screen]}
              style={{
                width: '44px', height: '44px', borderRadius: '50%', border: 'none',
                background: (!input.trim() || isStreaming[screen]) ? '#ccc' : '#007AFF',
                color: 'white', fontSize: '20px',
                cursor: (!input.trim() || isStreaming[screen]) ? 'not-allowed' : 'pointer',
                flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center'
              }}>
              â†‘
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>









