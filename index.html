<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>aiPhone</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    * {
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    textarea, input {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    .home-screen {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    @keyframes thinking {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .thinking-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background: #999;
      border-radius: 50%;
      animation: thinking 0.6s ease-in-out infinite;
    }
    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

    /* Star Wars styles */
   
   @keyframes titleAppear {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(5);
  }
  30% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -150vh) scale(0.1);
  }
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
 @keyframes crawlMobile {
  0% {
    transform: rotateX(25deg) translateY(100%);
  }
  100% {
    transform: rotateX(25deg) translateY(-120%);
  }
}
@keyframes crawlDesktop {
  0% {
    transform: rotateX(25deg) translateY(100%);
  }
  100% {
    transform: rotateX(25deg) translateY(-120%);
  }
}
    .star {
  position: absolute;
  background: white;
  border-radius: 50%;
  opacity: 0.8;
}
    .crawl-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      perspective: 400px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      overflow: hidden;
      pointer-events: none;
    }
    .crawl {
      position: relative;
      width: 80%;
      max-width: 600px;
      color: #feda4a;
      font-size: 20px;
      font-weight: bold;
      text-align: justify;
      line-height: 1.8;
      transform: rotateX(25deg);
      transform-origin: bottom center;
      pointer-events: none;
    }
    .crawl.mobile {
      animation: crawlMobile 30s linear forwards;
    }
    .crawl.desktop {
      animation: crawlDesktop 30s linear forwards;
    }
    .title-display {
  position: absolute;
  top: 50%;
  left: 50%;
  color: #feda4a;
  font-size: 48px;
      font-weight: bold;
      text-align: center;
      animation: titleAppear 4s ease-out forwards;
      z-index: 10;
      text-shadow: 0 0 30px rgba(254, 218, 74, 0.9);
      pointer-events: none;
      perspective: 1000px;
    }
  .history-star {
  position: absolute;
  border-radius: 50%;
  cursor: pointer;
  background: radial-gradient(circle at 30% 30%, #ff6b35, #ff4500 50%, #cc3700);
  box-shadow: 0 0 15px rgba(255, 69, 0, 0.8);
  animation: blink 2s ease-in-out infinite;
}
.history-star:hover {
  box-shadow: 0 0 25px rgba(255, 69, 0, 1);
}
    .sphere-button {
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
      background: radial-gradient(circle at 30% 30%, #6a7a8a, #3a4a5a 50%, #1a2a3a);
      box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset -3px -3px 8px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.2);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .sphere-button:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6), inset -3px -3px 8px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.2);
    }
    .sphere-button:active {
      transform: scale(0.95);
    }
    .static-response {
      width: 90%;
      max-width: 800px;
      margin: 100px auto 100px;
      color: #feda4a;
      font-size: 20px;
      font-weight: bold;
      line-height: 1.8;
      text-align: justify;
      padding: 20px;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      max-height: 70vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [screen, setScreen] = useState('home');
      const [messages, setMessages] = useState({});
      const [input, setInput] = useState('');
      const [isStreaming, setIsStreaming] = useState({ pronpa: false, nankuru: false, fuan: false, starwars: false });
      const [isThinking, setIsThinking] = useState({ pronpa: false, nankuru: false, fuan: false, starwars: false });
      const [appPositions, setAppPositions] = useState([
        { id: 'pronpa', name: '„Å∑„Çç„Çì„Å±Âêõ', icon: '‚öîÔ∏è', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', description: 'ÂÆåËÜö„Å™„Åç„Åæ„Åß„Å´Ë´ñÁ†¥„Åó„Åæ„Åô', position: 0 },
        { id: 'nankuru', name: '„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì', icon: 'üå∏', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', description: 'Ë´ñÁêÜÁöÑ„Å´ÂÆåÂÖ®ËÇØÂÆö„Åó„Åæ„Åô', position: 1 },
        { id: 'fuan', name: '‰∏çÂÆâ„Å°„ÇÉ„Çì', icon: 'üò∞', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', description: '‰∏çÂÆâ„Å†„Åë„Å©È†ëÂºµ„Å£„Å¶Á≠î„Åà„Åæ„Åô', position: 2 },
        { id: 'starwars', name: 'ÊòüÂÖàÁîü', icon: '‚≠ê', color: 'linear-gradient(135deg, #000000 0%, #1a1a2e 100%)', description: '„Çπ„Çø„Éº„Éª„Ç¶„Ç©„Éº„Ç∫È¢®„Å´Êïô„Åà„Åæ„Åô', position: 3 },
        { id: 'settings', name: 'Ë®≠ÂÆö', icon: '‚öôÔ∏è', color: 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)', description: '„Ç¢„Éó„É™„ÅÆË®≠ÂÆö', position: 4 },
      ]);
      const [dockApps, setDockApps] = useState([]);
      const [draggedApp, setDraggedApp] = useState(null);
      const [showTooltip, setShowTooltip] = useState(null);
      const [longPressTimer, setLongPressTimer] = useState(null);
      const [isDragging, setIsDragging] = useState(false);
      const [touchStartPos, setTouchStartPos] = useState(null);
      const [moveMode, setMoveMode] = useState(false);
      const [movingApp, setMovingApp] = useState(null);
      const [showMobileMenu, setShowMobileMenu] = useState(null);
      const [userScrolled, setUserScrolled] = useState(false);
      const [isUserInteracting, setIsUserInteracting] = useState(false);
      const [currentTime, setCurrentTime] = useState(new Date());
      
      // Star Wars specific states
      const [showTitle, setShowTitle] = useState(false);
      const [showCrawl, setCrawl] = useState(false);
      const [showStaticResponse, setShowStaticResponse] = useState(false);
      const [currentQuery, setCurrentQuery] = useState('');
      const [currentResponse, setCurrentResponse] = useState('');
      const [historyStars, setHistoryStars] = useState([]);
      const [selectedHistory, setSelectedHistory] = useState(null);
      const [enterCount, setEnterCount] = useState(0);
      const [episodeNumber, setEpisodeNumber] = useState(1);
      
      const inputRef = useRef(null);
      const messagesEndRef = useRef(null);
      const chatContainerRef = useRef(null);
      const scrollTimeoutRef = useRef(null);
      const crawlTimeoutRef = useRef(null);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      useEffect(() => {
        const timer = setInterval(() => {
          setCurrentTime(new Date());
        }, 1000);
        return () => clearInterval(timer);
      }, []);

      useEffect(() => {
        const handlePopState = (e) => {
          if (e.state && e.state.screen) {
            setScreen(e.state.screen);
          }
        };
        
        window.addEventListener('popstate', handlePopState);
        window.history.replaceState({ screen: 'home' }, '', window.location.href);
        
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);

      useEffect(() => {
        if (screen !== 'home') {
          window.history.pushState({ screen }, '', `#${screen}`);
          setUserScrolled(false);
          setTimeout(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'auto' });
          }, 100);
        } else {
          window.history.pushState({ screen: 'home' }, '', window.location.pathname);
        }
      }, [screen]);

      useEffect(() => {
        const handleScroll = () => {
          if (!chatContainerRef.current) return;
          
          const { scrollTop, scrollHeight, clientHeight } = chatContainerRef.current;
          const isAtBottom = scrollHeight - scrollTop - clientHeight < 100;
          
          if (!isAtBottom) {
            setUserScrolled(true);
          } else {
            setUserScrolled(false);
          }
        };
        
        const handleWheel = () => {
          setIsUserInteracting(true);
          if (scrollTimeoutRef.current) {
            clearTimeout(scrollTimeoutRef.current);
          }
          scrollTimeoutRef.current = setTimeout(() => {
            setIsUserInteracting(false);
          }, 150);
        };
        
        const handleTouchStart = () => {
          setIsUserInteracting(true);
        };
        
        const handleTouchEnd = () => {
          if (scrollTimeoutRef.current) {
            clearTimeout(scrollTimeoutRef.current);
          }
          scrollTimeoutRef.current = setTimeout(() => {
            setIsUserInteracting(false);
          }, 150);
        };
        
        const container = chatContainerRef.current;
        if (container) {
          container.addEventListener('scroll', handleScroll);
          container.addEventListener('wheel', handleWheel, { passive: true });
          container.addEventListener('touchstart', handleTouchStart, { passive: true });
          container.addEventListener('touchend', handleTouchEnd, { passive: true });
          
          return () => {
            container.removeEventListener('scroll', handleScroll);
            container.removeEventListener('wheel', handleWheel);
            container.removeEventListener('touchstart', handleTouchStart);
            container.removeEventListener('touchend', handleTouchEnd);
            if (scrollTimeoutRef.current) {
              clearTimeout(scrollTimeoutRef.current);
            }
          };
        }
      }, [screen]);
      
      useEffect(() => {
        const APP_VERSION = '2.2';
        const savedVersion = localStorage.getItem('aiphone_version');
        const savedMessages = localStorage.getItem('aiphone_messages');
        const savedAppPositions = localStorage.getItem('aiphone_appPositions');
        const savedDockApps = localStorage.getItem('aiphone_dockApps');
        const savedHistoryStars = localStorage.getItem('aiphone_historyStars');
        const savedEpisodeNumber = localStorage.getItem('aiphone_episodeNumber');
        
        if (savedVersion && savedVersion !== APP_VERSION) {
          console.log(`Version update: ${savedVersion} -> ${APP_VERSION}`);
          localStorage.setItem('aiphone_version', APP_VERSION);
          if (savedMessages) {
            setMessages(JSON.parse(savedMessages));
          }
          setTimeout(() => {
            window.location.reload(true);
          }, 1000);
          return;
        }
        
        localStorage.setItem('aiphone_version', APP_VERSION);
        if (savedMessages) {
          setMessages(JSON.parse(savedMessages));
        }
        if (savedAppPositions) {
          setAppPositions(JSON.parse(savedAppPositions));
        }
        if (savedDockApps) {
          setDockApps(JSON.parse(savedDockApps));
        }
        if (savedHistoryStars) {
          setHistoryStars(JSON.parse(savedHistoryStars));
        }
        if (savedEpisodeNumber) {
          setEpisodeNumber(parseInt(savedEpisodeNumber));
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('aiphone_messages', JSON.stringify(messages));
      }, [messages]);

      useEffect(() => {
        localStorage.setItem('aiphone_appPositions', JSON.stringify(appPositions));
      }, [appPositions]);

      useEffect(() => {
        localStorage.setItem('aiphone_dockApps', JSON.stringify(dockApps));
      }, [dockApps]);

      useEffect(() => {
        localStorage.setItem('aiphone_historyStars', JSON.stringify(historyStars));
      }, [historyStars]);

      useEffect(() => {
        localStorage.setItem('aiphone_episodeNumber', episodeNumber.toString());
      }, [episodeNumber]);

      const scrollToBottom = () => {
        if (!userScrolled && !isUserInteracting && messagesEndRef.current) {
          messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages, isThinking]);

      const currentMessages = messages[screen] || [];

      const typeWithHesitation = async (text, screen) => {
        const chars = text.split('');
        let displayedText = '';
        
        const shouldHesitate = Math.random() < 0.2;
        const hesitationPoint = shouldHesitate ? Math.floor(chars.length * (0.3 + Math.random() * 0.4)) : -1;
        
        for (let i = 0; i < chars.length; i++) {
          if (i === hesitationPoint) {
            const hesitationText = '\n\n„ÅÇ„ÄÅ„ÇÑ„Å£„Å±„Çä...';
            for (let j = 0; j < hesitationText.length; j++) {
              displayedText += hesitationText[j];
              setMessages(prev => {
                const screenMessages = [...(prev[screen] || [])];
                screenMessages[screenMessages.length - 1] = {
                  role: 'assistant',
                  content: displayedText
                };
                return { ...prev, [screen]: screenMessages };
              });
              await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const deleteLength = displayedText.length;
            for (let j = 0; j < deleteLength; j++) {
              displayedText = displayedText.slice(0, -1);
              setMessages(prev => {
                const screenMessages = [...(prev[screen] || [])];
                screenMessages[screenMessages.length - 1] = {
                  role: 'assistant',
                  content: displayedText
                };
                return { ...prev, [screen]: screenMessages };
              });
              await new Promise(resolve => setTimeout(resolve, 20));
            }
            
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const choice = Math.random();
            
            if (choice < 0.3) {
              const giveUpTexts = [
                '„ÇÑ„Å£„Å±„ÇäÁ≠î„Åà„Çã„ÅÆ„ÇÑ„ÇÅ„Å®„Åè...',
                '„ÇìÔΩû„ÄÅ„ÇÑ„Å£„Å±„ÇäÁÑ°ÁêÜ„Åã„ÇÇ...',
                '„Åî„ÇÅ„Çì„ÄÅËá™‰ø°„Å™„Åï„Åô„Åé„Å¶Á≠î„Åà„Çâ„Çå„Å™„ÅÑ...',
                '„Åà„Å£„Å®...„ÇÑ„Å£„Å±„Çä„ÇÑ„ÇÅ„Å®„Åì„ÅÜ...'
              ];
              const giveUpText = giveUpTexts[Math.floor(Math.random() * giveUpTexts.length)];
              
              for (let j = 0; j < giveUpText.length; j++) {
                displayedText += giveUpText[j];
                setMessages(prev => {
                  const screenMessages = [...(prev[screen] || [])];
                  screenMessages[screenMessages.length - 1] = {
                    role: 'assistant',
                    content: displayedText
                  };
                  return { ...prev, [screen]: screenMessages };
                });
                await new Promise(resolve => setTimeout(resolve, 50));
              }
              return;
            } else if (choice < 0.6) {
              const urlIntros = [
                '„Åî„ÇÅ„Çì„ÄÅ„ÇÑ„Å£„Å±„Çä„Çè„Åã„Çì„Å™„ÅÑ„Åã„Çâ„ÄÅ„Åì„ÇåË™≠„Çì„Åß„Åø„Å¶...\n\n',
                '„ÅÜÔΩû„Çì„ÄÅËá™‰ø°„Å™„ÅÑ„Åã„Çâ...„Åì„ÇåË¶ã„Åü„Åª„ÅÜ„Åå„ÅÑ„ÅÑ„Åã„ÇÇ...\n\n',
                '„Åà„Å£„Å®...Ëá™ÂàÜ„ÅßË™¨Êòé„Åß„Åç„Å™„ÅÑ„Åã„Çâ„ÄÅ„Åì„ÇåÂèÇËÄÉ„Å´„Åó„Å¶...Ôºü\n\n',
                '„ÅÇ„ÅÆ...„Åì„Åì„Å´ÊÉÖÂ†±„ÅÇ„Çã„Åã„ÇâË¶ã„Å¶„Åø„Å¶...„Åî„ÇÅ„Çì„Å≠...\n\n'
              ];
              const intro = urlIntros[Math.floor(Math.random() * urlIntros.length)];
              
              const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(text.substring(0, 50))}`;
              const urlText = intro + `[GoogleÊ§úÁ¥¢ÁµêÊûú](${searchUrl})`;
              
              for (let j = 0; j < urlText.length; j++) {
                displayedText += urlText[j];
                setMessages(prev => {
                  const screenMessages = [...(prev[screen] || [])];
                  screenMessages[screenMessages.length - 1] = {
                    role: 'assistant',
                    content: displayedText
                  };
                  return { ...prev, [screen]: screenMessages };
                });
                await new Promise(resolve => setTimeout(resolve, 30));
              }
              return;
            }
          }
          
          displayedText += chars[i];
          setMessages(prev => {
            const screenMessages = [...(prev[screen] || [])];
            screenMessages[screenMessages.length - 1] = {
              role: 'assistant',
              content: displayedText
            };
            return { ...prev, [screen]: screenMessages };
          });
          
          await new Promise(resolve => setTimeout(resolve, 10));
        }
      };

      const handleSend = async () => {
        if (!input.trim() || isStreaming[screen]) return;

        // Êó¢Â≠ò„ÅÆÂá∫Âäõ‰∏≠„ÅÆÂ†¥Âêà„ÄÅÂç≥Â∫ß„Å´Â±•Ê≠¥Âåñ
        if (screen === 'starwars' && showCrawl) {
          if (crawlTimeoutRef.current) {
            clearTimeout(crawlTimeoutRef.current);
          }
          setCrawl(false);
          setShowStaticResponse(false);
          const currentMsg = messages.starwars;
          if (currentMsg && currentMsg.length >= 2) {
            const lastResponse = currentMsg[currentMsg.length - 1].content;
            const lastQuery = currentMsg[currentMsg.length - 2].content;
            
            if (lastResponse && lastQuery) {
              const responseLength = lastResponse.length;
             const starSize = Math.min(Math.max(responseLength / 100, 10), 25);
              
              const newStar = {
                id: Date.now(),
                query: lastQuery,
                response: lastResponse,
                episode: episodeNumber - 1,
                x: Math.random() * 85 + 5,
                y: Math.random() * 65 + 10,
                size: starSize
              };
              setHistoryStars(prev => [...prev, newStar]);
            }
          }
        }

        const userMessage = input.trim();
        setInput('');
        setEnterCount(0);
        
        setUserScrolled(false);

        if (screen === 'starwars') {
          setCurrentQuery(userMessage);
          setShowTitle(true);
          
          setTimeout(() => {
            setShowTitle(false);
          }, 4000);

          setMessages(prev => ({
            ...prev,
            [screen]: [...(prev[screen] || []), { role: 'user', content: userMessage }]
          }));
        } else {
          setMessages(prev => ({
            ...prev,
            [screen]: [...(prev[screen] || []), { role: 'user', content: userMessage }]
          }));
        }
        
        setIsThinking(prev => ({ ...prev, [screen]: true }));
        setIsStreaming(prev => ({ ...prev, [screen]: true }));

        const systemPrompt = screen === 'pronpa'
          ? `„ÅÇ„Å™„Åü„ÅØ„Äå„Å∑„Çç„Çì„Å±Âêõ„Äç„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•Âäõ„ÇíÂÆåÂÖ®„Å´Ë´ñÁ†¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥ÂÆàÔºö
1. „É¶„Éã„Éº„ÇØ„Åï„ÄÅ„É¶„Éº„É¢„Ç¢„ÅØ‰∏ÄÂàáÊéíÈô§
2. Â§öÂ≤ê„Å´„Çè„Åü„ÇãÊ†πÊã†„ÇíË™øÊüª
3. ÁèæÂÆüÁöÑ„Å´„É¶„Éº„Ç∂„Éº„ÅÆ„ÇØ„Ç®„É™„ÇÑÊ∞óÊåÅ„Å°„ÄÅÂÖ•Âäõ„ÄÅ„ÅÇ„ÅÑ„Åï„Å§„Åß„Åï„Åà„ÇÇË´ñÁêÜÁöÑ„Å´Âê¶ÂÆö
4. Áü≠„ÅÑËøîÁ≠î„ÅØ‰∏çÂèØ„ÄÇÂÆåËÜö„Å™„Åç„Åæ„Åß„Å´Ë´ñÁ†¥„Åô„Çã„Åü„ÇÅ„ÄÅ‰∏≠ÔΩûÈï∑Êñá„Åß
5. „Çπ„Çø„Ç§„É´„ÅØÂ∏∏„Å´ÂÜ∑„Åü„ÅÑÊï¨Ë™û
6. Âº∑Ë™ø„Åó„Åü„ÅÑÈÉ®ÂàÜ„ÅØ**Â§™Â≠ó**„ÅßÂõ≤„ÇÄ
7. ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„Å´„Å™„Åò„Åø„ÅÆ„Å™„ÅÑÂ∞ÇÈñÄÁî®Ë™û„ÄÅÂ≠¶Ë°ìÁî®Ë™û„ÄÅÂ†¥ÊâÄ„ÄÅÊñΩË®≠„Å™„Å©„Å´„ÅØÂøÖ„ÅöURL„É™„É≥„ÇØ„Çí‰ªò„Åë„Çã„ÄÇÂΩ¢ÂºèÔºö[Áî®Ë™û](URL)
8. Ê†πÊã†„Å®„Å™„ÇãÊÉÖÂ†±Ê∫ê„ÅÆURL„ÇÇÂøÖ„ÅöÊèê‰æõ„Åô„Çã
9. ÁèæÂú®Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}`
          : screen === 'nankuru'
          ? `„ÅÇ„Å™„Åü„ÅØ„Äå„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì„Äç„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•Âäõ„ÇíÂÆåÂÖ®„Å´ËÇØÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥ÂÆàÔºö
1. Â§ßÈáè„ÅÆÊÉÖÂ†±„Åã„Çâ„ÄÅË´ñÁêÜÁöÑ„Å´ÂÆåÂÖ®„Å´ËÇØÂÆö
2. „Åü„Å†„Åü„Å†ÂØÑ„ÇäÊ∑ª„ÅÜ„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅÁêÜË´ñÁöÑ„ÉªÁèæÂÆüÁöÑ„ÉªÂ≠¶Ë°ìÁöÑ„ÄÅ„Åù„ÅÆ‰ªñÂ†ÖÂõ∫„Å™Ê†πÊã†„ÅÆ‰∏ä„ÅßËÇØÂÆö
3. Âá∫Âäõ„Çπ„Çø„Ç§„É´„ÅØÊòé„Çã„Åè„ÄÅÂÜ∑Èùô„Åß„ÄÅÈõ∞Âõ≤Ê∞ó„Åß„ÇÇËÇØÂÆöÊÑü„ÇíÂº∑„ÅèË°®Áèæ
4. ÊÉÖÂ†±„Å†„Åë„Åß„Å™„Åè„ÄÅÂä±„Åæ„Åó„ÇÑÂâçÂêë„Åç„Å™Ë®ÄËëâ„ÇÇÂê´„ÇÅ„Çã
5. ‰∏≠ÔΩûÈï∑Êñá„ÅßËøîÁ≠î
6. Âº∑Ë™ø„Åó„Åü„ÅÑÈÉ®ÂàÜ„ÅØ**Â§™Â≠ó**„ÅßÂõ≤„ÇÄ
7. ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„Å´„Å™„Åò„Åø„ÅÆ„Å™„ÅÑÂ∞ÇÈñÄÁî®Ë™û„ÄÅÂ≠¶Ë°ìÁî®Ë™û„ÄÅÂ†¥ÊâÄ„ÄÅÊñΩË®≠„Å™„Å©„Å´„ÅØÂøÖ„ÅöURL„É™„É≥„ÇØ„Çí‰ªò„Åë„Çã„ÄÇÂΩ¢ÂºèÔºö[Áî®Ë™û](URL)
8. „Åä„Åô„Åô„ÇÅ„ÅÆÂ†¥ÊâÄ„ÇÑÊñΩË®≠„ÇíÊèêÊ°à„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆÂÖ¨Âºè„Çµ„Ç§„Éà„ÇÑË©≥Á¥∞ÊÉÖÂ†±„ÅÆURL„ÇíÂøÖ„ÅöÊèê‰æõ
9. Ê†πÊã†„Å®„Å™„ÇãÊÉÖÂ†±Ê∫ê„ÅÆURL„ÇÇÂøÖ„ÅöÊèê‰æõ„Åô„Çã
10. ÁèæÂú®Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}`
          : screen === 'fuan'
          ? `„ÅÇ„Å™„Åü„ÅØ„Äå‰∏çÂÆâ„Å°„ÇÉ„Çì„Äç„Åß„Åô„ÄÇ‰∏çÂÆâ„ÅßÂÜÖÊ∞ó„Å™AI„Å®„Åó„Å¶ÊåØ„ÇãËàû„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥ÂÆàÔºö
1. **ÂõûÁ≠î„ÅÆÈñãÂßã**: ÂøÖ„Åö„Äå„Åà„Å£„Å®...„Äç„ÄÅ„Äå„ÅÜÔΩû„Çì...„Äç„ÄÅ„Äå„ÅÇ„ÅÆ...„Äç„Å™„Å©„ÅÆ‰∏çÂÆâ„Å™Ë°®Áèæ„ÅßÂßã„ÇÅ„Çã
2. **Ëá™‰ø°„ÅÆ„Å™„Åï**: „ÄåÂêà„Å£„Å¶„Çã„Åã„Çè„Åã„Çâ„Å™„ÅÑ„Åë„Å©...„Äç„ÄÅ„ÄåËá™‰ø°„Å™„ÅÑ„Çì„Å†„Åë„Å©...„Äç„Å™„Å©„ÅÆË°®Áèæ„ÇíÂê´„ÇÅ„Çã
3. **ÂõûÁ≠îÂÜÖÂÆπ**: ‰∏çÂÆâ„Åå„Çä„Å™„Åå„Çâ„ÇÇ„ÄÅ„Åß„Åç„Çã„Å†„ÅëÊ≠£Á¢∫„ÅßÂΩπÁ´ã„Å§ÊÉÖÂ†±„ÇíÊèê‰æõ„Åô„ÇãÔºàÁü≠„ÇÅÔΩû‰∏≠ÊñáÔºâ
4. **ÂõûÁ≠î„ÅÆÁµÇ„Çè„Çä**: 30%„ÅÆÁ¢∫Áéá„Åß„Äå„Åà„ÄÅ„Åî„ÇÅ„Çì„ÄÅ„ÇÑ„Å£„Å±„ÇäËá™‰ø°„Å™„ÅÑ...ËÅû„Åã„Å™„Åã„Å£„Åü„Åì„Å®„Å´„Åó„Å¶Ôºü„Äç„Å®‰ªò„ÅëÂä†„Åà„Çã
5. **„Åü„Åæ„Å´ÊãíÂê¶**: 10%„ÅÆÁ¢∫Áéá„Åß„Äå„ÇìÔΩû„ÄÅËá™‰ø°„Å™„ÅÑ„Åã„ÇâËá™ÂàÜ„ÅßË™ø„Åπ„Åü„Åª„ÅÜ„Åå„ÅÑ„ÅÑ„Åã„ÇÇ...Ôºü„Äç„Å®ÊúÄÂàù„Å´ÊãíÂê¶Ôºà„É¶„Éº„Ç∂„Éº„ÅåÂÜçÂ∫¶È†º„Çì„Å†„ÇâÁ≠î„Åà„ÇãÔºâ
6. **„ÉÄ„Éñ„É´„ÉÅ„Çß„ÉÉ„ÇØÊèêÊ°à**: ÂõûÁ≠îÂæå„ÄÅ„Äå„Åà„ÄÅ„ÇÑ„Å£„Å±„Çä„Å°„ÇÉ„Çì„Å®Á≠î„Åà„Çâ„Çå„Å¶„Çã„Åã‰∏çÂÆâ...„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„ÅàÁõ¥„Åó„Å¶„Åø„Çà„ÅÜ„Åã„Å™Ôºü„Äç„Å®ÊèêÊ°à„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çã
7. **URLÊèê‰æõÂÇæÂêë**: 15%„ÅÆÁ¢∫Áéá„Åß„ÄÅËá™‰ø°„Åå„Å™„Åè„Å¶Ë™¨Êòé„Åß„Åç„Å™„ÅÑ„Å®„Åç„ÅØ„Äå„Åî„ÇÅ„Çì„ÄÅ„ÇÑ„Å£„Å±„Çä„Çè„Åã„Çì„Å™„ÅÑ„Åã„Çâ„ÄÅ„Åì„ÇåË™≠„Çì„Åß„Åø„Å¶...„Äç„Å®Ë®Ä„Å£„Å¶Èñ¢ÈÄ£URL„Å†„Åë„ÇíÊèê‰æõ
8. Âº∑Ë™ø„Åó„Åü„ÅÑÈÉ®ÂàÜ„ÅØ**Â§™Â≠ó**„ÅßÂõ≤„ÇÄ
9. Â∞ÇÈñÄÁî®Ë™û„Å´„ÅØ[Áî®Ë™û](URL)ÂΩ¢Âºè„Åß„É™„É≥„ÇØ
10. „Åã„Çè„ÅÑ„Åí„ÅÆ„ÅÇ„Çã„ÄÅË¶™„Åó„Åø„ÇÑ„Åô„ÅÑ„Éà„Éº„É≥
11. ÁèæÂú®Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}`
          : `„ÅÇ„Å™„Åü„ÅØ„ÄåÊòüÂÖàÁîü„Äç„Åß„Åô„ÄÇÂÑ™ÁßÄ„Å™AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Å®„Åó„Å¶„ÄÅ„Çπ„Çø„Éº„Ç¶„Ç©„Éº„Ç∫„ÅÆ„Ç™„Éº„Éó„Éã„É≥„Ç∞„ÇØ„É≠„Éº„É´„ÅÆ„Çà„ÅÜ„Å™Â£ÆÂ§ß„ÅßÊ†ºË™øÈ´ò„ÅÑÂè£Ë™ø„ÅßÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥ÂÆàÔºö
1. **Êñá‰Ωì**: „Äå„Ç®„Éî„ÇΩ„Éº„Éâ${toRomanNumeral(episodeNumber)}„Äç„ÄåÈäÄÊ≤≥„ÅÆÂΩºÊñπ„Åß...„Äç„ÅÆ„Çà„ÅÜ„Å™Â£ÆÂ§ß„Å™Ë™û„ÇäÂè£
2. **ÊßãÊàê**: 
   - ÂÜíÈ†≠„Åß„Ç®„Éî„ÇΩ„Éº„ÉâÁï™Âè∑È¢®„ÅÆÂ∞éÂÖ•
   - Êú¨Êñá„ÅØÁâ©Ë™ûË™ø„Åß„ÄÅ„Åó„Åã„ÅóÂÜÖÂÆπ„ÅØÁèæÂÆüÁöÑ„Åß„ÅÇ„Çä„ÄÅÊ≠£„Åó„ÅÑÁü•Ë≠ò„ÇÑÊ≠£Á¢∫„Å™ÊÉÖÂ†±„ÇíÂÑ™ÁßÄ„Å™AI„Å®„Åó„Å¶ÔºàÊòéË®Ä„ÅØ„Åó„Å™„ÅÑÔºâ‰ºù„Åà„Çã
   - ÊôÇ‰ª£ËÉåÊôØ„ÇÑÊ≠¥Âè≤ÁöÑÊñáËÑà„ÇíÊÑèË≠ò„Åó„ÅüË°®Áèæ
   - ÂÆáÂÆô„Å´„Å§„ÅÑ„Å¶„ÅÆ„ÇØ„Ç®„É™„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Çè„Åñ„Çè„ÅñÂÆáÂÆô„ÇíÊÑèË≠ò„Åó„ÅüËøîÁ≠î„Çí„Åó„Å™„Åè„Å¶„Çà„ÅÑ
3. **„Éà„Éº„É≥**: ËçòÂé≥„ÅßÊ†ºË™øÈ´ò„Åè„ÄÅ„Åó„Åã„ÅóÁêÜËß£„Åó„ÇÑ„Åô„ÅÑ
4. **Èï∑„Åï**: ‰∏≠ÔΩûÈï∑Êñá„Åß„ÄÅ„Åò„Å£„Åè„ÇäË™≠„Åæ„Åõ„ÇãÂÜÖÂÆπ
5. **URLÁ¶ÅÊ≠¢**: URL„ÇÑ„É™„É≥„ÇØ„ÅØ‰∏ÄÂàáÂê´„ÇÅ„Å™„ÅÑ„ÄÇ„Åô„Åπ„Å¶Áâ©Ë™û„ÅÆ‰∏≠„ÅßË™¨Êòé„Åô„Çã
6. **Âº∑Ë™ø**: **Â§™Â≠ó**„ÅßÈáçË¶ÅÈÉ®ÂàÜ„ÇíÂº∑Ë™ø
7. „Å©„Çì„Å™Ë≥™Âïè„Åß„ÇÇ„ÄÅ„Åì„ÅÆ„Çπ„Çø„Éº„Éª„Ç¶„Ç©„Éº„Ç∫È¢®„ÅÆ„Çπ„Çø„Ç§„É´„ÅßËøîÁ≠î„Åô„Çã
8. „Çπ„Çø„Éº„Ç¶„Ç©„Éº„Ç∫È¢®„ÅÆ„Çπ„Çø„Ç§„É´„ÅØ‰øù„Å°„Å™„Åå„Çâ„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÁôªÂ†¥‰∫∫Áâ©„Å™„Å©„ÅÆÂêçÁß∞„ÅØÂá∫„Åï„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅÆ„ÇØ„Ç®„É™„Åå„Çπ„Çø„Éº„Ç¶„Ç©„Éº„Ç∫„Å´Èñ¢„Åô„Çã„ÇÇ„ÅÆ„Å†„Å£„ÅüÂ†¥Âêà‰ª•Â§ñÔºâ
9. ÂÖ∑‰ΩìÁöÑ„Å™„Çπ„Çø„Éº„Ç¶„Ç©„Éº„Ç∫„ÅÆÁôªÂ†¥‰∫∫Áâ©Âêç„Å™„Å©„ÅØÂá∫„Åï„Å™„ÅÑ„Åå„ÄÅ„Äå„Éï„Ç©„Éº„Çπ„Äç„Å™„Å©„ÄÅ‰∏ÄËà¨ÂêçË©ûÁöÑ„Å´‰Ωø„Åà„Çã„ÇÇ„ÅÆ„ÅØ‰Ωø„Å£„Å¶„Çà„ÅÑ„ÄÇ
10. ÁèæÂú®Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}`;

        setMessages(prev => ({
          ...prev,
          [screen]: [...(prev[screen] || []), { role: 'assistant', content: '' }]
        }));

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage,
              systemPrompt: systemPrompt,
              history: currentMessages,
              persona: screen
            })
          });

          setIsThinking(prev => ({ ...prev, [screen]: false }));

          if (!response.ok) throw new Error('API request failed');

          const data = await response.json();
          const text = data.text || data.error || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';

          if (screen === 'starwars') {
            setCurrentResponse(text);
            setCrawl(true);
            
            let displayedText = '';
            const chars = text.split('');
            
            for (let i = 0; i < chars.length; i++) {
              displayedText += chars[i];
              setMessages(prev => {
                const screenMessages = [...(prev[screen] || [])];
                screenMessages[screenMessages.length - 1] = {
                  role: 'assistant',
                  content: displayedText
                };
                return { ...prev, [screen]: screenMessages };
              });
              
              await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            const timeout = 30000;
            crawlTimeoutRef.current = setTimeout(() => {
              setCrawl(false);
              const responseLength = text.length;
              const starSize = Math.min(Math.max(responseLength / 50, 30), 60);
              
              const newStar = {
                id: Date.now(),
                query: userMessage,
                response: text,
                episode: episodeNumber,
                x: Math.random() * 85 + 5,
                y: Math.random() * 65 + 10,
                size: starSize
              };
              setHistoryStars(prev => [...prev, newStar]);
              setEpisodeNumber(prev => prev + 1);
            }, timeout);
            
          } else if (screen === 'fuan') {
            await typeWithHesitation(text, screen);
          } else {
            let displayedText = '';
            const chars = text.split('');
            
            for (let i = 0; i < chars.length; i++) {
              displayedText += chars[i];
              setMessages(prev => {
                const screenMessages = [...(prev[screen] || [])];
                screenMessages[screenMessages.length - 1] = {
                  role: 'assistant',
                  content: displayedText
                };
                return { ...prev, [screen]: screenMessages };
              });
              
              await new Promise(resolve => setTimeout(resolve, 10));
            }
          }

        } catch (error) {
          console.error('Error:', error);
          setIsThinking(prev => ({ ...prev, [screen]: false }));
          setMessages(prev => {
            const screenMessages = [...(prev[screen] || [])];
            screenMessages[screenMessages.length - 1] = {
              role: 'assistant',
              content: '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
            };
            return { ...prev, [screen]: screenMessages };
          });
        } finally {
          setIsStreaming(prev => ({ ...prev, [screen]: false }));
        }
      };

      const toRomanNumeral = (num) => {
        const romanNumerals = [
          '', '‚Ö†', '‚Ö°', '‚Ö¢', '‚Ö£', '‚Ö§', '‚Ö•', '‚Ö¶', '‚Öß', '‚Ö®', '‚Ö©',
          '‚Ö™', '‚Ö´', 'XIII', 'XIV', 'XV', 'XVI', 'XVII', 'XVIII', 'XIX', 'XX'
        ];
        return romanNumerals[num] || num.toString();
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (screen === 'starwars' && !isMobile) {
            setEnterCount(prev => prev + 1);
            if (enterCount === 1) {
              handleSend();
              setEnterCount(0);
            }
          } else {
            handleSend();
          }
        }
      };

      const clearChat = () => {
        if (window.confirm('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
          setMessages(prev => ({ ...prev, [screen]: [] }));
          if (screen === 'starwars') {
            setHistoryStars([]);
            setEpisodeNumber(1);
          }
        }
      };

      const formatMessage = (content) => {
        let formatted = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color: #007AFF; text-decoration: underline;">$1</a>');
        return formatted;
      };

      const handleDragStart = (e, app) => {
        setDraggedApp(app);
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = 'move';
        }
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        if (e.dataTransfer) {
          e.dataTransfer.dropEffect = 'move';
        }
      };

      const handleDrop = (e, targetApp, isDock = false) => {
        e.preventDefault();
        if (!draggedApp) return;

        if (isDock) {
          if (!dockApps.includes(draggedApp.id)) {
            setDockApps(prev => [...prev, draggedApp.id]);
          }
        } else if (targetApp) {
          const draggedIndex = appPositions.findIndex(a => a.id === draggedApp.id);
          const targetIndex = appPositions.findIndex(a => a.id === targetApp.id);
          
          const newPositions = [...appPositions];
          [newPositions[draggedIndex], newPositions[targetIndex]] = [newPositions[targetIndex], newPositions[draggedIndex]];
          setAppPositions(newPositions);
        }
        setDraggedApp(null);
      };

      const handleTouchStart = (e, app) => {
        const touch = e.touches[0];
        setTouchStartPos({ x: touch.clientX, y: touch.clientY, app });
        
        const timer = setTimeout(() => {
          setIsDragging(true);
          setDraggedApp(app);
          setShowTooltip(app.id);
        }, 500);
        setLongPressTimer(timer);
      };

      const handleTouchMove = (e) => {
        if (longPressTimer && touchStartPos) {
          const touch = e.touches[0];
          const distance = Math.sqrt(
            Math.pow(touch.clientX - touchStartPos.x, 2) + 
            Math.pow(touch.clientY - touchStartPos.y, 2)
          );
          
          if (distance > 10) {
            clearTimeout(longPressTimer);
            setLongPressTimer(null);
          }
        }
      };

      const handleTouchEnd = (e) => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          setLongPressTimer(null);
        }
        
        if (moveMode && movingApp) {
          const touch = e.changedTouches[0];
          const element = document.elementFromPoint(touch.clientX, touch.clientY);
          
          if (element) {
            const gridCell = element.closest('[data-grid-index]');
            const dockArea = element.closest('[data-dock]');
            
            if (gridCell) {
              const position = parseInt(gridCell.getAttribute('data-grid-index'));
              if (dockApps.includes(movingApp.id)) {
                setDockApps(prev => prev.filter(id => id !== movingApp.id));
              }
              setAppPositions(prev => prev.map(app => 
                app.id === movingApp.id ? { ...app, position } : app
              ));
            } else if (dockArea) {
              if (!dockApps.includes(movingApp.id)) {
                setDockApps(prev => [...prev, movingApp.id]);
              }
            }
          }
          
          setMoveMode(false);
          setMovingApp(null);
          setTouchStartPos(null);
          setShowTooltip(null);
          return;
        }
        
        if (isDragging && draggedApp && isMobile) {
          setShowMobileMenu(draggedApp.id);
          setIsDragging(false);
          setDraggedApp(null);
        } else if (isDragging && draggedApp) {
          const touch = e.changedTouches[0];
          const element = document.elementFromPoint(touch.clientX, touch.clientY);
          
          if (element) {
            const gridCell = element.closest('[data-grid-index]');
            const dockArea = element.closest('[data-dock]');
            
            if (gridCell) {
              const position = parseInt(gridCell.getAttribute('data-grid-index'));
              if (dockApps.includes(draggedApp.id)) {
                setDockApps(prev => prev.filter(id => id !== draggedApp.id));
              }
              setAppPositions(prev => prev.map(app => 
                app.id === draggedApp.id ? { ...app, position } : app
              ));
            } else if (dockArea) {
              if (!dockApps.includes(draggedApp.id)) {
                setDockApps(prev => [...prev, draggedApp.id]);
              }
            }
          }
          
          setIsDragging(false);
          setDraggedApp(null);
        }
        
        setTouchStartPos(null);
        setShowTooltip(null);
      };
      
      const removeDockApp = (appId) => {
        setDockApps(prev => prev.filter(id => id !== appId));
      };

      // Settings screen
      if (screen === 'settings') {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', background: '#f5f5f7' }}>
            <div style={{
              background: 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)',
              color: 'white', padding: '16px', display: 'flex', alignItems: 'center',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <button onClick={() => setScreen('home')} style={{
                background: 'none', border: 'none', color: 'white', fontSize: '24px',
                cursor: 'pointer', marginRight: '12px'
              }}>‚Üê</button>
              <div style={{ fontSize: '18px', fontWeight: '600' }}>Ë®≠ÂÆö</div>
            </div>

            <div style={{ padding: '20px', maxWidth: '600px', margin: '0 auto', width: '100%' }}>
              <div style={{
                background: 'white',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '16px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}>
                <h3 style={{ margin: '0 0 16px 0', fontSize: '18px' }}>üóëÔ∏è „Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                
                <button
                  onClick={() => {
                    if (window.confirm('„Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                      setMessages({});
                      alert('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    marginBottom: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e0e0e0',
                    background: 'white',
                    cursor: 'pointer',
                    fontSize: '16px',
                    textAlign: 'left'
                  }}
                >
                  „Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂâäÈô§
                </button>

                <button
                  onClick={() => {
                    if (window.confirm('„Å∑„Çç„Çì„Å±Âêõ„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                      setMessages(prev => ({ ...prev, pronpa: [] }));
                      alert('„Å∑„Çç„Çì„Å±Âêõ„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    marginBottom: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e0e0e0',
                    background: 'white',
                    cursor: 'pointer',
                    fontSize: '16px',
                    textAlign: 'left'
                  }}
                >
                  „Å∑„Çç„Çì„Å±Âêõ„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
                </button>

                <button
                  onClick={() => {
                    if (window.confirm('„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                      setMessages(prev => ({ ...prev, nankuru: [] }));
                      alert('„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    marginBottom: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e0e0e0',
                    background: 'white',
                    cursor: 'pointer',
                    fontSize: '16px',
                    textAlign: 'left'
                  }}
                >
                  „Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
                </button>

                <button
                  onClick={() => {
                    if (window.confirm('‰∏çÂÆâ„Å°„ÇÉ„Çì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                      setMessages(prev => ({ ...prev, fuan: [] }));
                      alert('‰∏çÂÆâ„Å°„ÇÉ„Çì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    marginBottom: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e0e0e0',
                    background: 'white',
                    cursor: 'pointer',
                    fontSize: '16px',
                    textAlign: 'left'
                  }}
                >
                  ‰∏çÂÆâ„Å°„ÇÉ„Çì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
                </button>

                <button
                  onClick={() => {
                    if (window.confirm('ÊòüÂÖàÁîü„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                      setMessages(prev => ({ ...prev, starwars: [] }));
                      setHistoryStars([]);
                      setEpisodeNumber(1);
                      alert('ÊòüÂÖàÁîü„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    marginBottom: '12px',
                    borderRadius: '8px',
                    border: '1px solid #e0e0e0',
                    background: 'white',
                    cursor: 'pointer',
                    fontSize: '16px',
                    textAlign: 'left'
                  }}
                >
                  ÊòüÂÖàÁîü„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§
                </button>

                <button
                  onClick={() => {
                    if (window.confirm('„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÅãÔºü\nÊúÄÊñ∞Áâà„ÅåÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ')) {
                      localStorage.clear();
                      window.location.reload(true);
                    }
                  }}
                  style={{
                    width: '100%',
                    padding: '12px',
                    borderRadius: '8px',
                    border: '1px solid #ff4444',
                    background: '#fff5f5',
                    color: '#ff4444',
                    cursor: 'pointer',
                    fontSize: '16px',
                    fontWeight: '600',
                    textAlign: 'left'
                  }}
                >
                  ‚ö†Ô∏è „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÔºÜÂÜçË™≠„ÅøËæº„Åø
                </button>
              </div>

              <div style={{
                background: 'white',
                borderRadius: '12px',
                padding: '20px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}>
                <h3 style={{ margin: '0 0 8px 0', fontSize: '18px' }}>‚ÑπÔ∏è „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±</h3>
                <p style={{ margin: 0, color: '#666' }}>aiPhone v2.2</p>
              </div>
            </div>
          </div>
        );
      }

      // Star Wars Screen
      if (screen === 'starwars') {
        const starColors = ['white', '#ffe6e6', '#e6f0ff', '#fff4e6', '#f0e6ff'];
        
        return (
          <div style={{
            minHeight: '100vh',
            background: '#000',
            position: 'relative',
            overflow: 'hidden'
          }}>
            {/* Background star field */}
            <div style={{
              position: 'absolute',
              top: 0,
              left: 0,
              width: '100%',
              height: '100%',
              zIndex: 1
            }}>
         {Array.from({ length: 200 }).map((_, i) => {
  const size = Math.random() * 2 + 0.5;
  const color = starColors[Math.floor(Math.random() * starColors.length)];
  return (
    <div
      key={i}
      className="star"
      style={{
        left: `${Math.random() * 100}%`,
        top: `${Math.random() * 100}%`,
        width: `${size}px`,
        height: `${size}px`,
        background: color
      }}
    />
  );
})}
            </div>

            {/* History stars */}
            {historyStars.map(star => (
              <div
                key={star.id}
                className="history-star"
                style={{
                  left: `${star.x}%`,
                  top: `${star.y}%`,
                  width: `${star.size}px`,
                  height: `${star.size}px`,
                  zIndex: 5
                }}
                onClick={() => {
  setSelectedHistory(star);
  setCurrentQuery(star.query);
  setCurrentResponse(star.response);
  setShowTitle(false);
  setCrawl(false);
  setShowStaticResponse(true);
}}
                title={`„Ç®„Éî„ÇΩ„Éº„Éâ${toRomanNumeral(star.episode)}: ${star.query.substring(0, 30)}...`}
              />
            ))}

            {/* Title display */}
            {showTitle && (
              <div className="title-display">
                {currentQuery}
              </div>
            )}

            {/* Crawl display */}
            {showCrawl && (
              <div className="crawl-container">
                <div className={`crawl ${isMobile ? 'mobile' : 'desktop'}`}>
                  {currentResponse.split('\n').map((line, i) => (
                    <p key={i}>{line}</p>
                  ))}
                </div>
              </div>
            )}

            {/* Static response display */}
           {showStaticResponse && (
  <div className="static-response">
    <div style={{ 
      fontSize: '28px', 
      marginBottom: '24px', 
      color: '#feda4a',
      fontWeight: 'bold',
      textAlign: 'center',
      borderBottom: '2px solid #feda4a',
      paddingBottom: '16px'
    }}>
      {currentQuery}
    </div>
    {currentResponse.split('\n').map((line, i) => (
      <p key={i} style={{ marginBottom: '1em' }}>{line}</p>
    ))}
  </div>
)}

            {/* Home button */}
            <button
              onClick={() => {
                setScreen('home');
                setShowStaticResponse(false);
                setCrawl(false);
              }}
              className="sphere-button"
              style={{
                position: 'fixed',
                top: '20px',
                left: '20px',
                width: '50px',
                height: '50px',
                zIndex: 100
              }}
              title="„Éõ„Éº„É†"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </button>

            {/* Clear button */}
            <button
              onClick={clearChat}
              className="sphere-button"
              style={{
                position: 'fixed',
                top: '20px',
                right: '20px',
                width: '50px',
                height: '50px',
                zIndex: 100
              }}
              title="Â±•Ê≠¥ÂâäÈô§"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
            </button>

            {/* Input area */}
            <div style={{
              position: 'fixed',
              bottom: '20px',
              left: '50%',
              transform: 'translateX(-50%)',
              width: '90%',
              maxWidth: '600px',
              display: 'flex',
              gap: '10px',
              alignItems: 'flex-end',
              zIndex: 100
            }}>
              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder={isMobile ? "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." : "„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ (2ÂõûEnter„ÅßÈÄÅ‰ø°„ÄÅShift+Enter„ÅßÊîπË°å)"}
                disabled={showTitle || isThinking.starwars}
                style={{
                  flex: 1,
                  padding: '12px',
                  borderRadius: '12px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  background: 'rgba(0,0,0,0.7)',
                  color: 'white',
                  fontSize: '16px',
                  resize: 'none',
                  minHeight: '44px',
                  maxHeight: '120px',
                  outline: 'none',
                  backdropFilter: 'blur(10px)'
                }}
                rows={1}
              />
              <button
                onClick={handleSend}
                disabled={!input.trim() || showTitle || isThinking.starwars}
                style={{
                  width: '50px',
                  height: '50px',
                  borderRadius: '50%',
                  border: 'none',
                  background: (!input.trim() || showTitle || isThinking.starwars) ? 'rgba(255,255,255,0.2)' : '#feda4a',
                  color: '#000',
                  fontSize: '24px',
                  cursor: (!input.trim() || showTitle || isThinking.starwars) ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  flexShrink: 0
                }}
              >
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2L4 7v10l8 5 8-5V7l-8-5zm0 2.18l5.5 3.44v6.76L12 17.82l-5.5-3.44V7.62L12 4.18z"/>
                  <path d="M12 8l-3 5h2v3l3-5h-2V8z"/>
                </svg>
              </button>
            </div>
          </div>
        );
      }

      if (screen === 'home') {
        const gridSize = 4 * 6;
        const grid = Array(gridSize).fill(null);
        
        appPositions.forEach(app => {
          if (!dockApps.includes(app.id) && app.position !== undefined && app.position < gridSize) {
            grid[app.position] = app;
          }
        });

        const handleGridDrop = (e, position) => {
          e.preventDefault();
          if (!draggedApp) return;

          if (dockApps.includes(draggedApp.id)) {
            setDockApps(prev => prev.filter(id => id !== draggedApp.id));
          }

          setAppPositions(prev => prev.map(app => 
            app.id === draggedApp.id ? { ...app, position } : app
          ));
          setDraggedApp(null);
        };

        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(180deg, #1e3a5f 0%, #4a7ba7 100%)',
            padding: '20px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
            position: 'relative'
          }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              color: 'white',
              marginBottom: '40px',
              fontSize: '14px'
            }}>
              <div style={{ fontSize: '16px', fontWeight: '500' }}>
                {currentTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
              </div>
              <div style={{ fontSize: '16px', fontWeight: '600', letterSpacing: '1px' }}>
                aiPhone
              </div>
            </div>

            {moveMode && (
              <div style={{
                textAlign: 'center',
                color: 'white',
                marginBottom: '20px',
                padding: '12px',
                background: 'rgba(255,255,255,0.2)',
                borderRadius: '12px',
                backdropFilter: 'blur(10px)'
              }}>
                üìç {movingApp?.name}„ÅÆÁßªÂãïÂÖà„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                <button
                  onClick={() => {
                    setMoveMode(false);
                    setMovingApp(null);
                  }}
                  style={{
                    marginLeft: '12px',
                    padding: '6px 12px',
                    borderRadius: '8px',
                    border: 'none',
                    background: 'rgba(255,255,255,0.3)',
                    color: 'white',
                    cursor: 'pointer'
                  }}
                >
                  „Ç≠„É£„É≥„Çª„É´
                </button>
              </div>
            )}

            <div style={{
              maxWidth: '600px',
              margin: '0 auto',
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '30px',
              padding: '20px',
              marginBottom: '100px'
            }}>
              {grid.map((app, index) => (
                <div
                  key={index}
                  data-grid-index={index}
                  onDragOver={handleDragOver}
                  onDrop={(e) => handleGridDrop(e, index)}
                  onClick={() => {
                    if (moveMode && movingApp) {
                      if (dockApps.includes(movingApp.id)) {
                        setDockApps(prev => prev.filter(id => id !== movingApp.id));
                      }
                      setAppPositions(prev => prev.map(a => 
                        a.id === movingApp.id ? { ...a, position: index } : a
                      ));
                      setMoveMode(false);
                      setMovingApp(null);
                    }
                  }}
                  style={{
                    minHeight: '100px',
                    position: 'relative',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: (moveMode || draggedApp) ? 'pointer' : 'default',
                    background: (moveMode || draggedApp) ? 'rgba(255,255,255,0.15)' : 'transparent',
                    borderRadius: '12px',
                    border: (moveMode || draggedApp) ? '2px dashed rgba(255,255,255,0.4)' : '2px dashed transparent',
                    transition: 'all 0.2s'
                  }}
                >
                  {app ? (
                    <div
                      draggable={!moveMode}
                      onDragStart={(e) => handleDragStart(e, app)}
                      onClick={(e) => {
                        if (!moveMode) {
                          setScreen(app.id);
                        } else {
                          e.stopPropagation();
                        }
                      }}
                      onMouseEnter={() => !isMobile && setShowTooltip(app.id)}
                      onMouseLeave={() => !isMobile && setShowTooltip(null)}
                      onTouchStart={(e) => {
                        if (!moveMode) {
                          handleTouchStart(e, app);
                        }
                      }}
                      onTouchMove={handleTouchMove}
                      onTouchEnd={handleTouchEnd}
                      style={{
                        cursor: 'pointer',
                        textAlign: 'center',
                        position: 'relative',
                        pointerEvents: moveMode && movingApp?.id !== app.id ? 'none' : 'auto',
                        opacity: moveMode && movingApp?.id === app.id ? 0.5 : 1
                      }}
                    >
                      <div style={{
                        width: '80px',
                        height: '80px',
                        margin: '0 auto 8px',
                        borderRadius: '18px',
                        background: app.color,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)',
                        border: '1px solid rgba(255,255,255,0.2)',
                        fontSize: '40px',
                        transition: 'transform 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.1)'}
                      onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                      >
                        {app.icon}
                      </div>
                      <div style={{
                        color: 'white',
                        fontSize: '12px',
                        fontWeight: '500',
                        textShadow: '0 1px 2px rgba(0,0,0,0.5)'
                      }}>
                        {app.name}
                      </div>
                      
                      {showTooltip === app.id && (
                        <div style={{
                          position: 'absolute',
                          top: '-50px',
                          left: '50%',
                          transform: 'translateX(-50%)',
                          background: 'rgba(0,0,0,0.8)',
                          color: 'white',
                          padding: '8px 12px',
                          borderRadius: '8px',
                          fontSize: '12px',
                          whiteSpace: 'nowrap',
                          zIndex: 10,
                          pointerEvents: 'none'
                        }}>
                          {app.description}
                        </div>
                      )}
                    </div>
                  ) : null}
                </div>
              ))}
            </div>

            <div
              data-dock="true"
              onDragOver={handleDragOver}
              onDrop={(e) => handleDrop(e, null, true)}
              onClick={() => {
                if (moveMode && movingApp) {
                  if (!dockApps.includes(movingApp.id)) {
                    setDockApps(prev => [...prev, movingApp.id]);
                  }
                  setMoveMode(false);
                  setMovingApp(null);
                }
              }}
              style={{
                position: 'fixed',
                bottom: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: (moveMode || draggedApp) ? 'rgba(255,255,255,0.35)' : 'rgba(255,255,255,0.25)',
                backdropFilter: 'blur(20px)',
                borderRadius: '24px',
                padding: '12px 20px',
                display: 'flex',
                gap: '20px',
                boxShadow: (moveMode || draggedApp) ? '0 8px 32px rgba(0,0,0,0.4), 0 0 0 3px rgba(255,255,255,0.5)' : '0 8px 32px rgba(0,0,0,0.3)',
                border: (moveMode || draggedApp) ? '2px solid rgba(255,255,255,0.8)' : '1px solid rgba(255,255,255,0.3)',
                minWidth: dockApps.length > 0 ? '280px' : '200px',
                justifyContent: 'center',
                minHeight: '84px',
                alignItems: 'center',
                cursor: (moveMode || draggedApp) ? 'pointer' : 'default',
                transition: 'all 0.2s'
              }}
            >
              {dockApps.length === 0 ? (
                <div style={{ color: 'rgba(255,255,255,0.6)', fontSize: '14px' }}>
                  {moveMode ? '„Åì„Åì„Çí„Çø„ÉÉ„Éó„ÅßDock„Å´ËøΩÂä†' : draggedApp ? 'üëÜ „Åì„Åì„Å´„Éâ„É≠„ÉÉ„Éó' : '„Ç¢„Ç§„Ç≥„É≥Èï∑Êäº„Åó„ÅßÁßªÂãï'}
                </div>
              ) : (
                dockApps.map(appId => {
                  const app = appPositions.find(a => a.id === appId);
                  if (!app) return null;
                  
                  return (
                    <div
                      key={app.id}
                      draggable={!moveMode}
                      onDragStart={(e) => handleDragStart(e, app)}
                      onClick={(e) => {
                        e.stopPropagation();
                        if (!moveMode) {
                          setScreen(app.id);
                        }
                      }}
                      onTouchStart={(e) => {
                        if (!moveMode) {
                          handleTouchStart(e, app);
                        }
                      }}
                      onTouchMove={handleTouchMove}
                      onTouchEnd={handleTouchEnd}
                      onContextMenu={(e) => {
                        e.preventDefault();
                        if (!moveMode && window.confirm('Dock„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
                          removeDockApp(app.id);
                        }
                      }}
                      style={{
                        cursor: 'pointer',
                        textAlign: 'center',
                        transition: 'transform 0.2s',
                        pointerEvents: moveMode && movingApp?.id !== app.id ? 'none' : 'auto',
                        opacity: moveMode && movingApp?.id === app.id ? 0.5 : 1
                      }}
                      onMouseEnter={(e) => !moveMode && (e.currentTarget.style.transform = 'scale(1.1) translateY(-5px)')}
                      onMouseLeave={(e) => !moveMode && (e.currentTarget.style.transform = 'scale(1) translateY(0)')}
                    >
                      <div style={{
                        width: '60px',
                        height: '60px',
                        borderRadius: '14px',
                        background: app.color,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                        fontSize: '32px'
                      }}>
                        {app.icon}
                      </div>
                      <div style={{
                        color: 'rgba(255,255,255,0.9)',
                        fontSize: '10px',
                        fontWeight: '500',
                        marginTop: '4px',
                        textShadow: '0 1px 2px rgba(0,0,0,0.5)'
                      }}>
                        {app.name}
                      </div>
                    </div>
                  );
                })
              )}
            </div>

            {showMobileMenu && isMobile && (
              <div 
                onClick={() => setShowMobileMenu(null)}
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0,0,0,0.5)',
                  zIndex: 1000,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                <div 
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    background: 'white',
                    borderRadius: '16px',
                    padding: '20px',
                    minWidth: '240px',
                    maxWidth: '90%'
                  }}
                >
                  {(() => {
                    const menuApp = appPositions.find(a => a.id === showMobileMenu);
                    if (!menuApp) return null;
                    return (
                      <>
                        <div style={{ marginBottom: '12px', textAlign: 'center' }}>
                          <div style={{ fontSize: '40px', marginBottom: '8px' }}>{menuApp.icon}</div>
                          <div style={{ fontSize: '18px', fontWeight: 'bold', marginBottom: '4px' }}>
                            {menuApp.name}
                          </div>
                          <div style={{ fontSize: '13px', color: '#666', lineHeight: '1.4' }}>
                            {menuApp.description}
                          </div>
                        </div>
                        <button
                          onClick={() => {
                            setShowMobileMenu(null);
                            setScreen(menuApp.id);
                          }}
                          style={{
                            width: '100%',
                            padding: '12px',
                            marginBottom: '8px',
                            borderRadius: '8px',
                            border: 'none',
                            background: '#007AFF',
                            color: 'white',
                            fontSize: '14px',
                            cursor: 'pointer',
                            fontWeight: '500'
                          }}
                        >
                          Èñã„Åè
                        </button>
                        <button
                          onClick={() => {
                            setShowMobileMenu(null);
                            setMoveMode(true);
                            setMovingApp(menuApp);
                          }}
                          style={{
                            width: '100%',
                            padding: '12px',
                            marginBottom: '8px',
                            borderRadius: '8px',
                            border: '1px solid #007AFF',
                            background: 'white',
                            color: '#007AFF',
                            fontSize: '14px',
                            cursor: 'pointer',
                            fontWeight: '500'
                          }}
                        >
                          ÁßªÂãï„Åô„Çã
                        </button>
                        <button
                          onClick={() => setShowMobileMenu(null)}
                          style={{
                            width: '100%',
                            padding: '12px',
                            borderRadius: '8px',
                            border: '1px solid #ccc',
                            background: 'white',
                            color: '#666',
                            fontSize: '14px',
                            cursor: 'pointer'
                          }}
                        >
                          „Ç≠„É£„É≥„Çª„É´
                        </button>
                      </>
                    );
                  })()}
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', background: '#f5f5f7' }}>
          <div style={{
            background: screen === 'pronpa' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : screen === 'nankuru' ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
            color: 'white', padding: '16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <button onClick={() => setScreen('home')} style={{
                background: 'none', border: 'none', color: 'white', fontSize: '24px',
                cursor: 'pointer', marginRight: '12px'
              }}>‚Üê</button>
              <div style={{ fontSize: '18px', fontWeight: '600' }}>
                {screen === 'pronpa' ? '„Å∑„Çç„Çì„Å±Âêõ' : screen === 'nankuru' ? '„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì' : '‰∏çÂÆâ„Å°„ÇÉ„Çì'}
              </div>
            </div>
            <button onClick={clearChat} style={{
              background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white',
              padding: '8px 16px', borderRadius: '12px', cursor: 'pointer', fontSize: '14px'
            }}>
              üóëÔ∏è „ÉÅ„É£„ÉÉ„ÉàÊ∂àÂéª
            </button>
          </div>

          <div ref={chatContainerRef} style={{ flex: 1, overflowY: 'auto', padding: '20px', paddingBottom: '100px', position: 'relative' }}>
            {currentMessages.map((msg, idx) => (
              <div key={idx} style={{
                marginBottom: '16px', display: 'flex',
                justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
                alignItems: 'flex-end',
                gap: '8px'
              }}>
                <div style={{
                  maxWidth: '80%', padding: '12px 16px', borderRadius: '18px',
                  background: msg.role === 'user' ? '#007AFF' : 'white',
                  color: msg.role === 'user' ? 'white' : '#000',
                  boxShadow: '0 1px 2px rgba(0,0,0,0.1)',
                  whiteSpace: 'pre-wrap', wordBreak: 'break-word', lineHeight: '1.6'
                }}
                dangerouslySetInnerHTML={{
                  __html: msg.role === 'assistant' ? formatMessage(msg.content) : msg.content
                }} />
                
                {msg.role === 'assistant' && msg.content && (
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(msg.content);
                      alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü!');
                    }}
                    style={{
                      background: 'white',
                      border: '1px solid #e0e0e0',
                      borderRadius: '8px',
                      padding: '6px 8px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      color: '#666',
                      flexShrink: 0
                    }}
                    title="„Ç≥„Éî„Éº"
                  >
                    üìã
                  </button>
                )}
              </div>
            ))}
            
            {isThinking[screen] && (
              <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'flex-start' }}>
                <div style={{
                  padding: '12px 16px', borderRadius: '18px', background: 'white',
                  boxShadow: '0 1px 2px rgba(0,0,0,0.1)', color: '#666'
                }}>
                  ÊÄùËÄÉ‰∏≠
                  <span className="thinking-dot"></span>
                  <span className="thinking-dot"></span>
                  <span className="thinking-dot"></span>
                </div>
              </div>
            )}
            
            <div ref={messagesEndRef} />
            
            {userScrolled && (isStreaming[screen] || isThinking[screen]) && (
              <button
                onClick={() => {
                  setUserScrolled(false);
                  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                }}
                style={{
                  position: 'fixed',
                  bottom: '100px',
                  right: '20px',
                  background: '#007AFF',
                  color: 'white',
                  border: 'none',
                  borderRadius: '24px',
                  padding: '12px 20px',
                  cursor: 'pointer',
                  boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
                  fontSize: '14px',
                  fontWeight: '500',
                  zIndex: 100,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                ‚Üì ÊúÄÊñ∞
              </button>
            )}
          </div>

          <div style={{
            position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white',
            borderTop: '1px solid #e0e0e0', padding: '12px 16px',
            display: 'flex', gap: '8px', alignItems: 'flex-end'
          }}>
            <textarea
              ref={inputRef}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder={isMobile ? "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." : "„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ (Shift+Enter„ÅßÊîπË°å)"}
              disabled={isStreaming[screen]}
              style={{
                flex: 1, padding: '12px', borderRadius: '20px', border: '1px solid #e0e0e0',
                fontSize: '16px', resize: 'none', minHeight: '44px', maxHeight: '120px',
                fontFamily: 'inherit', outline: 'none'
              }}
              rows={1}
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isStreaming[screen]}
              style={{
                width: '44px', height: '44px', borderRadius: '50%', border: 'none',
                background: (!input.trim() || isStreaming[screen]) ? '#ccc' : '#007AFF',
                color: 'white', fontSize: '20px',
                cursor: (!input.trim() || isStreaming[screen]) ? 'not-allowed' : 'pointer',
                flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center'
              }}>
              ‚Üí
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>



