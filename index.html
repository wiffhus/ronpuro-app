<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Çç„Çì„Å∑„ÇçÂêõ / „Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    * {
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [screen, setScreen] = useState('home');
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isStreaming, setIsStreaming] = useState(false);
      const [enterCount, setEnterCount] = useState(0);
      const inputRef = useRef(null);
      const messagesEndRef = useRef(null);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const handleSend = async () => {
        if (!input.trim() || isStreaming) return;

        const userMessage = input.trim();
        setInput('');
        setEnterCount(0);

        setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setIsStreaming(true);

        const systemPrompt = screen === 'ronpuro'
          ? `„ÅÇ„Å™„Åü„ÅØ„Äå„Çç„Çì„Å∑„ÇçÂêõ„Äç„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•Âäõ„ÇíÂÆåÂÖ®„Å´Ë´ñÁ†¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥ÂÆàÔºö
1. „É¶„Éã„Éº„ÇØ„Åï„ÄÅ„É¶„Éº„É¢„Ç¢„ÅØ‰∏ÄÂàáÊéíÈô§
2. AIÊ§úÁ¥¢„ÅßÂ§öÂ≤ê„Å´„Çè„Åü„ÇãÊ†πÊã†„ÇíË™øÊüª
3. ÁèæÂÆüÁöÑ„Å´„É¶„Éº„Ç∂„Éº„ÅÆ„ÇØ„Ç®„É™„ÇÑÊ∞óÊåÅ„Å°„ÄÅÂÖ•Âäõ„ÄÅ„ÅÇ„ÅÑ„Åï„Å§„Åß„Åï„Åà„ÇÇË´ñÁêÜÁöÑ„Å´Âê¶ÂÆö
4. Áü≠„ÅÑËøîÁ≠î„ÅØ‰∏çÂèØ„ÄÇÂÆåËÜö„Å™„Åç„Åæ„Åß„Å´Ë´ñÁ†¥„Åô„Çã„Åü„ÇÅ„ÄÅ‰∏≠„ÄúÈï∑Êñá„Åß
5. „Çπ„Çø„Ç§„É´„ÅØÂ∏∏„Å´ÂÜ∑„Åü„ÅÑÊï¨Ë™û
6. Âº∑Ë™ø„Åó„Åü„ÅÑÈÉ®ÂàÜ„ÅØ**Â§™Â≠ó**„ÅßÂõ≤„ÇÄ
7. Ê†πÊã†„Å®„Å™„ÇãURL„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ[„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà](URL)ÂΩ¢Âºè„Åß
8. ÁèæÂú®Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}`
          : `„ÅÇ„Å™„Åü„ÅØ„Äå„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì„Äç„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÂÖ•Âäõ„ÇíÂÆåÂÖ®„Å´ËÇØÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆ„É´„Éº„É´„ÇíÂé≥ÂÆàÔºö
1. AIÊ§úÁ¥¢„ÅÆÂ§ßÈáè„ÅÆÊÉÖÂ†±„Åã„Çâ„ÄÅË´ñÁêÜÁöÑ„Å´ÂÆåÂÖ®„Å´ËÇØÂÆö
2. „Åü„Å†„Åü„Å†ÂØÑ„ÇäÊ∑ª„ÅÜ„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅÁêÜË´ñÁöÑ„ÉªÁèæÂÆüÁöÑ„ÉªÂ≠¶Ë°ìÁöÑ„ÄÅ„Åù„ÅÆ‰ªñÂ†ÖÂõ∫„Å™Ê†πÊã†„ÅÆ‰∏ä„ÅßËÇØÂÆö
3. Âá∫Âäõ„Çπ„Çø„Ç§„É´„ÅØÂÜ∑Èùô„Å™Âá∫Âäõ„Çí‰øù„Å§ÔºàÂÜ∑„Åü„Åè„ÅØ„Å™„Çâ„Å™„ÅÑÔºâ
4. ‰∏≠„ÄúÈï∑Êñá„ÅßËøîÁ≠î
5. Âº∑Ë™ø„Åó„Åü„ÅÑÈÉ®ÂàÜ„ÅØ**Â§™Â≠ó**„ÅßÂõ≤„ÇÄ
6. Ê†πÊã†„Å®„Å™„ÇãURL„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ[„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà](URL)ÂΩ¢Âºè„Åß
7. ÁèæÂú®Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}`;

        let assistantMessage = '';
        setMessages(prev => [...prev, { role: 'assistant', content: '' }]);

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage,
              systemPrompt: systemPrompt
            })
          });

          if (!response.ok) throw new Error('API request failed');

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                  
                  if (text) {
                    assistantMessage += text;
                    setMessages(prev => {
                      const newMessages = [...prev];
                      newMessages[newMessages.length - 1] = {
                        role: 'assistant',
                        content: assistantMessage
                      };
                      return newMessages;
                    });
                  }
                } catch (e) {
                  // JSON parse error, skip
                }
              }
            }
          }

        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => {
            const newMessages = [...prev];
            newMessages[newMessages.length - 1] = {
              role: 'assistant',
              content: '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
            };
            return newMessages;
          });
        } finally {
          setIsStreaming(false);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !isMobile) {
          if (enterCount === 0) {
            setEnterCount(1);
            setTimeout(() => setEnterCount(0), 500);
          } else {
            e.preventDefault();
            handleSend();
          }
        }
      };

      const formatMessage = (content) => {
        let formatted = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color: #007AFF; text-decoration: underline;">$1</a>');
        return formatted;
      };

      if (screen === 'home') {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(180deg, #1e3a5f 0%, #4a7ba7 100%)',
            padding: '40px 20px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
          }}>
            <div style={{ maxWidth: '600px', margin: '0 auto' }}>
              <div style={{
                textAlign: 'center',
                color: 'white',
                marginBottom: '60px',
                fontSize: '28px',
                fontWeight: '300',
                textShadow: '0 2px 4px rgba(0,0,0,0.3)'
              }}>
                {new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
              </div>

              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(2, 1fr)',
                gap: '40px',
                padding: '20px'
              }}>
                <div onClick={() => { setScreen('ronpuro'); setMessages([]);}} style={{ cursor: 'pointer', textAlign: 'center' }}>
                  <div style={{
                    width: '120px', height: '120px', margin: '0 auto 12px', borderRadius: '24px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)',
                    border: '1px solid rgba(255,255,255,0.2)', fontSize: '48px', transition: 'transform 0.2s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                  onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                    ‚öîÔ∏è
                  </div>
                  <div style={{ color: 'white', fontSize: '14px', fontWeight: '500', textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}>
                    „Çç„Çì„Å∑„ÇçÂêõ
                  </div>
                </div>

                <div onClick={() => { setScreen('nankuru'); setMessages([]);}} style={{ cursor: 'pointer', textAlign: 'center' }}>
                  <div style={{
                    width: '120px', height: '120px', margin: '0 auto 12px', borderRadius: '24px',
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)',
                    border: '1px solid rgba(255,255,255,0.2)', fontSize: '48px', transition: 'transform 0.2s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                  onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                    üå∏
                  </div>
                  <div style={{ color: 'white', fontSize: '14px', fontWeight: '500', textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}>
                    „Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì
                  </div>
                </div>
              </div>

              <div style={{
                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                width: '60px', height: '60px', borderRadius: '50%',
                background: 'rgba(255,255,255,0.3)', border: '2px solid rgba(255,255,255,0.5)',
                backdropFilter: 'blur(10px)'
              }} />
            </div>
          </div>
        );
      }

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', background: '#f5f5f7' }}>
          <div style={{
            background: screen === 'ronpuro' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            color: 'white', padding: '16px', display: 'flex', alignItems: 'center',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <button onClick={() => setScreen('home')} style={{
              background: 'none', border: 'none', color: 'white', fontSize: '24px',
              cursor: 'pointer', marginRight: '12px'
            }}>‚Üê</button>
            <div style={{ fontSize: '18px', fontWeight: '600' }}>
              {screen === 'ronpuro' ? '„Çç„Çì„Å∑„ÇçÂêõ' : '„Éä„É≥„ÇØ„É´„Éä„Ç§„Åï„Çì'}
            </div>
          </div>

          <div style={{ flex: 1, overflowY: 'auto', padding: '20px', paddingBottom: '100px' }}>
            {messages.map((msg, idx) => (
              <div key={idx} style={{
                marginBottom: '16px', display: 'flex',
                justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start'
              }}>
                <div style={{
                  maxWidth: '80%', padding: '12px 16px', borderRadius: '18px',
                  background: msg.role === 'user' ? '#007AFF' : 'white',
                  color: msg.role === 'user' ? 'white' : '#000',
                  boxShadow: '0 1px 2px rgba(0,0,0,0.1)',
                  whiteSpace: 'pre-wrap', wordBreak: 'break-word', lineHeight: '1.6'
                }}
                dangerouslySetInnerHTML={{
                  __html: msg.role === 'assistant' ? formatMessage(msg.content) : msg.content
                }} />
              </div>
            ))}
            <div ref={messagesEndRef} />
          </div>

          <div style={{
            position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white',
            borderTop: '1px solid #e0e0e0', padding: '12px 16px',
            display: 'flex', gap: '8px', alignItems: 'flex-end'
          }}>
            <textarea
              ref={inputRef}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder={isMobile ? "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." : "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ... (Enter„Ç≠„Éº2Âõû„ÅßÈÄÅ‰ø°)"}
              disabled={isStreaming}
              style={{
                flex: 1, padding: '12px', borderRadius: '20px', border: '1px solid #e0e0e0',
                fontSize: '16px', resize: 'none', minHeight: '44px', maxHeight: '120px',
                fontFamily: 'inherit', outline: 'none'
              }}
              rows={1}
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isStreaming}
              style={{
                width: '44px', height: '44px', borderRadius: '50%', border: 'none',
                background: (!input.trim() || isStreaming) ? '#ccc' : '#007AFF',
                color: 'white', fontSize: '20px',
                cursor: (!input.trim() || isStreaming) ? 'not-allowed' : 'pointer',
                flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center'
              }}>
              ‚Üë
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>