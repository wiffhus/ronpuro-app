<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã·ã‚ã‚“ã±å› / ãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
@keyframes thinking {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  .thinking-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    margin: 0 2px;
    background: #999;
    border-radius: 50%;
    animation: thinking 0.6s ease-in-out infinite;
  }
  .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
    
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [screen, setScreen] = useState('home');
      const [messages, setMessages] = useState({});
      const [input, setInput] = useState('');
      const [isStreaming, setIsStreaming] = useState(false);
      const [isThinking, setIsThinking] = useState(false);
      const inputRef = useRef(null);
      const messagesEndRef = useRef(null);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages, isThinking]);

      const currentMessages = messages[screen] || [];

      const handleSend = async () => {
        if (!input.trim() || isStreaming[screen]) return;

        const userMessage = input.trim();
        setInput('');

        setMessages(prev => ({
          ...prev,
          [screen]: [...(prev[screen] || []), { role: 'user', content: userMessage }]
        }));
        
      setIsThinking(prev => ({ ...prev, [screen]: true }));
setIsStreaming(prev => ({ ...prev, [screen]: true }));

        const systemPrompt = screen === 'pronpa'
          ? `ã‚ãªãŸã¯ã€Œã·ã‚ã‚“ã±å›ã€ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å®Œå…¨ã«è«–ç ´ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆï¼š
1. ãƒ¦ãƒ‹ãƒ¼ã‚¯ã•ã€ãƒ¦ãƒ¼ãƒ¢ã‚¢ã¯ä¸€åˆ‡æ’é™¤
2. å¤šå²ã«ã‚ãŸã‚‹æ ¹æ‹ ã‚’èª¿æŸ»
3. ç¾å®Ÿçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã‚„æ°—æŒã¡ã€å…¥åŠ›ã€ã‚ã„ã•ã¤ã§ã•ãˆã‚‚è«–ç†çš„ã«å¦å®š
4. çŸ­ã„è¿”ç­”ã¯ä¸å¯ã€‚å®Œè†šãªãã¾ã§ã«è«–ç ´ã™ã‚‹ãŸã‚ã€ä¸­ã€œé•·æ–‡ã§
5. ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¸¸ã«å†·ãŸã„æ•¬èª
6. å¼·èª¿ã—ãŸã„éƒ¨åˆ†ã¯**å¤ªå­—**ã§å›²ã‚€
7. ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã˜ã¿ã®ãªã„å°‚é–€ç”¨èªã€å­¦è¡“ç”¨èªã€å ´æ‰€ã€æ–½è¨­ãªã©ã«ã¯å¿…ãšURLãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚å½¢å¼ï¼š[ç”¨èª](URL)
8. æ ¹æ‹ ã¨ãªã‚‹æƒ…å ±æºã®URLã‚‚å¿…ãšæä¾›ã™ã‚‹
9. ç¾åœ¨æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`
          : `ã‚ãªãŸã¯ã€ŒãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“ã€ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å®Œå…¨ã«è‚¯å®šã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆï¼š
1. å¤§é‡ã®æƒ…å ±ã‹ã‚‰ã€è«–ç†çš„ã«å®Œå…¨ã«è‚¯å®š
2. ãŸã ãŸã å¯„ã‚Šæ·»ã†ã®ã§ã¯ãªãã€ç†è«–çš„ãƒ»ç¾å®Ÿçš„ãƒ»å­¦è¡“çš„ã€ãã®ä»–å …å›ºãªæ ¹æ‹ ã®ä¸Šã§è‚¯å®š
3. å‡ºåŠ›ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ˜ã‚‹ãã€å†·é™ã§ã€é›°å›²æ°—ã§ã‚‚è‚¯å®šæ„Ÿã‚’å¼·ãè¡¨ç¾
4. æƒ…å ±ã ã‘ã§ãªãã€åŠ±ã¾ã—ã‚„å‰å‘ããªè¨€è‘‰ã‚‚å«ã‚ã‚‹
5. ä¸­ã€œé•·æ–‡ã§è¿”ç­”
6. å¼·èª¿ã—ãŸã„éƒ¨åˆ†ã¯**å¤ªå­—**ã§å›²ã‚€
7. ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã˜ã¿ã®ãªã„å°‚é–€ç”¨èªã€å­¦è¡“ç”¨èªã€å ´æ‰€ã€æ–½è¨­ãªã©ã«ã¯å¿…ãšURLãƒªãƒ³ã‚¯ã‚’ä»˜ã‘ã‚‹ã€‚å½¢å¼ï¼š[ç”¨èª](URL)
8. ãŠã™ã™ã‚ã®å ´æ‰€ã‚„æ–½è¨­ã‚’ææ¡ˆã™ã‚‹å ´åˆã¯ã€ãã®å…¬å¼ã‚µã‚¤ãƒˆã‚„è©³ç´°æƒ…å ±ã®URLã‚’å¿…ãšæä¾›
9. æ ¹æ‹ ã¨ãªã‚‹æƒ…å ±æºã®URLã‚‚å¿…ãšæä¾›ã™ã‚‹
10. ç¾åœ¨æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;

        setMessages(prev => ({
          ...prev,
          [screen]: [...(prev[screen] || []), { role: 'assistant', content: '' }]
        }));

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage,
              systemPrompt: systemPrompt
            })
          });

          setIsStreaming(prev => ({ ...prev, [screen]: false }));

          if (!response.ok) throw new Error('API request failed');

          const data = await response.json();
          const text = data.text || data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

          let displayedText = '';
          const chars = text.split('');
          
          for (let i = 0; i < chars.length; i++) {
            displayedText += chars[i];
            setMessages(prev => {
              const screenMessages = [...(prev[screen] || [])];
              screenMessages[screenMessages.length - 1] = {
                role: 'assistant',
                content: displayedText
              };
              return { ...prev, [screen]: screenMessages };
            });
            
            await new Promise(resolve => setTimeout(resolve, 10));
          }

        } catch (error) {
          console.error('Error:', error);
          setIsStreaming(prev => ({ ...prev, [screen]: false }));
          setMessages(prev => {
            const screenMessages = [...(prev[screen] || [])];
            screenMessages[screenMessages.length - 1] = {
              role: 'assistant',
              content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
            };
            return { ...prev, [screen]: screenMessages };
          });
        } finally {
          setIsStreaming(false);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      const clearChat = () => {
        if (window.confirm('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setMessages(prev => ({ ...prev, [screen]: [] }));
        }
      };

      const formatMessage = (content) => {
        let formatted = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color: #007AFF; text-decoration: underline;">$1</a>');
        return formatted;
      };

      if (screen === 'home') {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(180deg, #1e3a5f 0%, #4a7ba7 100%)',
            padding: '40px 20px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
          }}>
            <div style={{ maxWidth: '600px', margin: '0 auto' }}>
              <div style={{
                textAlign: 'center',
                color: 'white',
                marginBottom: '60px',
                fontSize: '28px',
                fontWeight: '300',
                textShadow: '0 2px 4px rgba(0,0,0,0.3)'
              }}>
                {new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
              </div>

              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(2, 1fr)',
                gap: '40px',
                padding: '20px'
              }}>
                <div onClick={() => setScreen('pronpa')} style={{ cursor: 'pointer', textAlign: 'center' }} title="å®Œè†šãªãã¾ã§ã«è«–ç ´ã—ã¾ã™">
                  <div style={{
                    width: '120px', height: '120px', margin: '0 auto 12px', borderRadius: '24px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)',
                    border: '1px solid rgba(255,255,255,0.2)', fontSize: '48px', transition: 'transform 0.2s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                  onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                    âš”ï¸
                  </div>
                  <div style={{ color: 'white', fontSize: '14px', fontWeight: '500', textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}>
                    ã·ã‚ã‚“ã±å›
                  </div>
                </div>

                <div onClick={() => setScreen('nankuru')} style={{ cursor: 'pointer', textAlign: 'center' }} title="è«–ç†çš„ã«å®Œå…¨è‚¯å®šã—ã¾ã™">
                  <div style={{
                    width: '120px', height: '120px', margin: '0 auto 12px', borderRadius: '24px',
                    background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)',
                    border: '1px solid rgba(255,255,255,0.2)', fontSize: '48px', transition: 'transform 0.2s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                  onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}>
                    ğŸŒ¸
                  </div>
                  <div style={{ color: 'white', fontSize: '14px', fontWeight: '500', textShadow: '0 1px 2px rgba(0,0,0,0.5)' }}>
                    ãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“
                  </div>
                </div>
              </div>

              <div style={{
                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                width: '60px', height: '60px', borderRadius: '50%',
                background: 'rgba(255,255,255,0.3)', border: '2px solid rgba(255,255,255,0.5)',
                backdropFilter: 'blur(10px)'
              }} />
            </div>
          </div>
        );
      }

      return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', background: '#f5f5f7' }}>
          <div style={{
            background: screen === 'pronpa' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            color: 'white', padding: '16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center' }}>
              <button onClick={() => setScreen('home')} style={{
                background: 'none', border: 'none', color: 'white', fontSize: '24px',
                cursor: 'pointer', marginRight: '12px'
              }}>â†</button>
              <div style={{ fontSize: '18px', fontWeight: '600' }}>
                {screen === 'pronpa' ? 'ã·ã‚ã‚“ã±å›' : 'ãƒŠãƒ³ã‚¯ãƒ«ãƒŠã‚¤ã•ã‚“'}
              </div>
            </div>
            <button onClick={clearChat} style={{
              background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white',
              padding: '8px 16px', borderRadius: '12px', cursor: 'pointer', fontSize: '14px'
            }}>
              ğŸ—‘ï¸ ãƒãƒ£ãƒƒãƒˆæ¶ˆå»
            </button>
          </div>

          <div style={{ flex: 1, overflowY: 'auto', padding: '20px', paddingBottom: '100px' }}>
           {currentMessages.map((msg, idx) => (
  <div key={idx} style={{
    marginBottom: '16px', display: 'flex',
    justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
    alignItems: 'flex-end',
    gap: '8px'
  }}>
    <div style={{
      maxWidth: '80%', padding: '12px 16px', borderRadius: '18px',
      background: msg.role === 'user' ? '#007AFF' : 'white',
      color: msg.role === 'user' ? 'white' : '#000',
      boxShadow: '0 1px 2px rgba(0,0,0,0.1)',
      whiteSpace: 'pre-wrap', wordBreak: 'break-word', lineHeight: '1.6'
    }}
    dangerouslySetInnerHTML={{
      __html: msg.role === 'assistant' ? formatMessage(msg.content) : msg.content
    }} />
    
    {msg.role === 'assistant' && msg.content && (
      <button
        onClick={() => {
          navigator.clipboard.writeText(msg.content);
          alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }}
        style={{
          background: 'white',
          border: '1px solid #e0e0e0',
          borderRadius: '8px',
          padding: '6px 8px',
          cursor: 'pointer',
          fontSize: '14px',
          color: '#666',
          flexShrink: 0
        }}
        title="ã‚³ãƒ”ãƒ¼"
      >
        ğŸ“‹
      </button>
    )}
  </div>
))}
            
         {isThinking[screen] && (
  <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'flex-start' }}>
    <div style={{
      padding: '12px 16px', borderRadius: '18px', background: 'white',
      boxShadow: '0 1px 2px rgba(0,0,0,0.1)', color: '#666'
    }}>
      æ€è€ƒä¸­
      <span className="thinking-dot"></span>
      <span className="thinking-dot"></span>
      <span className="thinking-dot"></span>
    </div>
  </div>
)}
            
            <div ref={messagesEndRef} />
          </div>

          <div style={{
            position: 'fixed', bottom: 0, left: 0, right: 0, background: 'white',
            borderTop: '1px solid #e0e0e0', padding: '12px 16px',
            display: 'flex', gap: '8px', alignItems: 'flex-end'
          }}>
            <textarea
              ref={inputRef}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder={isMobile ? "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› (Shift+Enterã§æ”¹è¡Œ)"}
               disabled={isStreaming[screen]}
              style={{
                flex: 1, padding: '12px', borderRadius: '20px', border: '1px solid #e0e0e0',
                fontSize: '16px', resize: 'none', minHeight: '44px', maxHeight: '120px',
                fontFamily: 'inherit', outline: 'none'
              }}
              rows={1}
            />
            <button
              onClick={handleSend}
             disabled={!input.trim() || isStreaming[screen]}
              style={{
                width: '44px', height: '44px', borderRadius: '50%', border: 'none',
                background: (!input.trim() || isStreaming) ? '#ccc' : '#007AFF',
                color: 'white', fontSize: '20px',
                cursor: (!input.trim() || isStreaming) ? 'not-allowed' : 'pointer',
                flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center'
              }}>
              â†‘
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>



